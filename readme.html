<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.3">
<meta name="author" content="v1.4, Nov 5, 2015">
<title>Docker and Kubernetes for Java Developers</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Docker and Kubernetes for Java Developers</h1>
<div class="details">
<span id="author" class="author">v1.4, Nov 5, 2015</span><br>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Latest HTML:
<a href="https://htmlpreview.github.io/?https://github.com/javaee-samples/docker-java/blob/master/readme.html" class="bare">https://htmlpreview.github.io/?https://github.com/javaee-samples/docker-java/blob/master/readme.html</a></p>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_preface">Preface</a></li>
<li><a href="#_setup_environments">Setup Environments</a>
<ul class="sectlevel2">
<li><a href="#_hardware">Hardware</a></li>
<li><a href="#_docker">Docker</a>
<ul class="sectlevel3">
<li><a href="#_docker_toolbox_or_packages">Docker Toolbox or Packages</a></li>
<li><a href="#_checkout_code_docker_java_code_workspace">Checkout <code>docker-java</code> workspace</a></li>
<li><a href="#_pull_docker_images">Pull Docker images</a></li>
<li><a href="#_create_docker_host_mapping">Create Docker Host Mapping</a></li>
<li><a href="#_optional_software">Optional Software</a></li>
</ul>
</li>
<li><a href="#Kubernetes_Setup">Kubernetes</a></li>
</ul>
</li>
<li><a href="#Docker_Basics">Docker Basics</a>
<ul class="sectlevel2">
<li><a href="#_docker_machine">Docker Machine</a></li>
<li><a href="#_docker_client">Docker Client</a></li>
<li><a href="#_verify_docker_configuration">Verify Docker Configuration</a></li>
</ul>
</li>
<li><a href="#_build_an_image">Build an Image</a>
<ul class="sectlevel2">
<li><a href="#_dockerfile">Dockerfile</a></li>
<li><a href="#_create_your_first_docker_image">Create your first Docker image</a></li>
<li><a href="#_wildfly_image">WildFly Image</a></li>
<li><a href="#_java_ee_7_application_image">Java EE 7 Application Image</a></li>
<li><a href="#_dockerfile_command_design_patterns">Dockerfile Command Design Patterns</a>
<ul class="sectlevel3">
<li><a href="#_difference_between_cmd_and_entrypoint">Difference between CMD and ENTRYPOINT</a></li>
<li><a href="#_difference_between_add_and_copy">Difference between ADD and COPY</a></li>
<li><a href="#_import_and_export_images">Import and export images</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_run_a_container">Run a Container</a>
<ul class="sectlevel2">
<li><a href="#_pull_image">Pull Image</a></li>
<li><a href="#_run_container">Run Container</a>
<ul class="sectlevel3">
<li><a href="#_interactive_container">Interactive Container</a></li>
<li><a href="#_detached_container">Detached Container</a></li>
</ul>
</li>
<li><a href="#_run_container_with_default_port">Run Container with Default Port</a></li>
<li><a href="#_run_container_with_specified_port">Run Container with Specified Port</a></li>
<li><a href="#_stop_container">Stop Container</a></li>
<li><a href="#_remove_container">Remove Container</a></li>
<li><a href="#Enabling_WildFly_Administration">Enable WildFly Administration</a>
<ul class="sectlevel3">
<li><a href="#_default_port_mapping">Default Port Mapping</a></li>
<li><a href="#Management_Fixed_Port_Mapping">Fixed Port Mapping</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#JavaEE7_PreBuilt_WAR">Deploy Java EE 7 Application (Pre-Built WAR)</a></li>
<li><a href="#JavaEE7_Container_Linking">Deploy Java EE 7 Application (Container Linking)</a></li>
<li><a href="#_build_and_deploy_java_ee_7_application">Build and Deploy Java EE 7 Application</a>
<ul class="sectlevel2">
<li><a href="#Build_Application">Build Application</a></li>
<li><a href="#_start_application_server">Start Application Server</a></li>
<li><a href="#_configure_jboss_developer_studio">Configure JBoss Developer Studio</a></li>
<li><a href="#_deploy_application_using_shared_volumes">Deploy Application Using Shared Volumes</a></li>
<li><a href="#_deploy_application_using_cli">Deploy Application Using CLI</a></li>
<li><a href="#_deploy_application_using_web_console">Deploy Application Using Web Console</a></li>
<li><a href="#_deploy_application_using_management_api">Deploy Application Using Management API</a></li>
</ul>
</li>
<li><a href="#_docker_maven_plugin">Docker Maven Plugin</a>
<ul class="sectlevel2">
<li><a href="#_run_java_ee_application">Run Java EE Application</a></li>
<li><a href="#_understand_plugin_configuration">Understand Plugin Configuration</a></li>
</ul>
</li>
<li><a href="#_docker_tools_in_eclipse">Docker Tools in Eclipse</a>
<ul class="sectlevel2">
<li><a href="#_install_docker_tools_plugins">Install Docker Tools Plugins</a></li>
<li><a href="#_docker_explorer">Docker Explorer</a></li>
<li><a href="#_docker_images">Docker Images</a></li>
<li><a href="#_docker_containers">Docker Containers</a></li>
<li><a href="#_details_on_images_and_containers">Details on Images and Containers</a></li>
</ul>
</li>
<li><a href="#_test_java_ee_applications_on_docker">Test Java EE Applications on Docker</a></li>
<li><a href="#Docker_Compose">Multiple Containers Using Docker Compose</a>
<ul class="sectlevel2">
<li><a href="#_single_host_container_linking">Single Host Container Linking</a>
<ul class="sectlevel3">
<li><a href="#_configuration_file">Configuration File</a></li>
<li><a href="#_start_services">Start Services</a></li>
<li><a href="#_verify_application">Verify Application</a></li>
<li><a href="#_stop_services">Stop Services</a></li>
<li><a href="#_remove_containers">Remove Containers</a></li>
<li><a href="#_scale_services">Scale Services</a></li>
</ul>
</li>
<li><a href="#_multi_host_networking">Multi-host Networking</a></li>
</ul>
</li>
<li><a href="#Docker_Swarm">Deploy Application on Docker Swarm Cluster</a>
<ul class="sectlevel2">
<li><a href="#_key_components_of_docker_swarm">Key Components of Docker Swarm</a></li>
<li><a href="#_create_discovery_service">Create Discovery Service</a></li>
<li><a href="#_create_docker_swarm_cluster">Create Docker Swarm Cluster</a></li>
<li><a href="#_start_application_environment_using_docker_compose">Start Application Environment Using Docker Compose</a></li>
<li><a href="#_configure_couchbase_server">Configure Couchbase server</a></li>
<li><a href="#_deploy_application">Deploy Application</a></li>
<li><a href="#_access_application">Access Application</a></li>
</ul>
</li>
<li><a href="#_deploy_application_on_kubernetes_cluster">Deploy Application on Kubernetes Cluster</a>
<ul class="sectlevel2">
<li><a href="#_key_components">Key Components</a></li>
<li><a href="#_start_kubernetes_cluster">Start Kubernetes Cluster</a>
<ul class="sectlevel3">
<li><a href="#_using_previously_downloaded_kubernetes_distribution">Using Previously Downloaded Kubernetes Distribution</a></li>
<li><a href="#_download_and_start_the_kubernetes_cluster">Download and Start the Kubernetes Cluster</a></li>
<li><a href="#_verify_the_cluster">Verify the Cluster</a></li>
</ul>
</li>
<li><a href="#Deploy_JavaEE_Kubernetes_Multiple_Config">Deploy Java EE Application (multiple configuration files)</a>
<ul class="sectlevel3">
<li><a href="#_start_couchbase_pod">Start Couchbase Pod</a></li>
<li><a href="#_start_couchbase_service">Start Couchbase service</a></li>
<li><a href="#_start_wildfly_replication_controller">Start WildFly Replication Controller</a></li>
<li><a href="#Access_Kubernetes_Application_Node">Access the application (using node)</a></li>
<li><a href="#Access_Kubernetes_Application_Proxy">Access the application (using proxy)</a></li>
</ul>
</li>
<li><a href="#_deploy_java_ee_application_one_configuration_file">Deploy Java EE Application (one configuration file)</a></li>
<li><a href="#_rescheduling_pods">Rescheduling Pods</a></li>
<li><a href="#_scaling_pods">Scaling Pods</a></li>
<li><a href="#_couchbase_cluster_and_persistent_volumes">Couchbase Cluster and Persistent Volumes</a>
<ul class="sectlevel3">
<li><a href="#_create_kubernetes_resources">Create Kubernetes resources</a></li>
<li><a href="#_initialize_couchbase_cluster">Initialize Couchbase Cluster</a></li>
<li><a href="#_add_a_new_couchbase_server_to_the_cluster">Add a new Couchbase server to the cluster</a></li>
</ul>
</li>
<li><a href="#_application_logs">Application Logs</a></li>
<li><a href="#_delete_kubernetes_resources">Delete Kubernetes Resources</a></li>
<li><a href="#_stop_kubernetes_cluster">Stop Kubernetes Cluster</a></li>
<li><a href="#_debug_kubernetes_master">Debug Kubernetes Master</a></li>
</ul>
</li>
<li><a href="#Common_Docker_Commands">Common Docker Commands</a></li>
<li><a href="#_troubleshooting">Troubleshooting</a>
<ul class="sectlevel2">
<li><a href="#_network_timed_out">Network Timed Out</a>
<ul class="sectlevel3">
<li><a href="#_restart_docker_machine">Restart Docker Machine</a></li>
<li><a href="#_loading_images_offline">Loading Images Offline</a></li>
</ul>
</li>
<li><a href="#_cannot_create_docker_machine_on_windows">Cannot create Docker Machine on Windows</a></li>
<li><a href="#_no_route_to_host">No route to host</a></li>
<li><a href="#_docker_machine_creation_fails_with_an_error_about_dial_tcp_i_o_timeout">Docker machine creation fails with an error about dial tcp: i/o timeout</a></li>
<li><a href="#__you_may_be_getting_rate_limited_by_github_error_message">&#8220;You may be getting rate limited by Github&#8221; error message</a></li>
<li><a href="#_docker_machine_troubleshooting">Docker Machine Troubleshooting</a></li>
</ul>
</li>
<li><a href="#_references">References</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Containers are enabling developers to package their applications (and underlying dependencies) in new ways that are portable and work consistently everywhere? On your machine, in production, in your data center, and in the cloud. And Docker has become the de facto standard for those portable containers in the cloud.</p>
</div>
<div class="paragraph">
<p>Docker is the developer-friendly Linux container technology that enables creation of your stack: OS, JVM, app server, app, and all your custom configuration. So with all it offers, how comfortable are you and your team taking Docker from development to production? Are you hearing developers say, “But it works on my machine!” when code breaks in production?</p>
</div>
<div class="paragraph">
<p>This lab offers developers an intro-level, hands-on session with Docker, from installation, to exploring Docker Hub, to crafting their own images, to adding Java apps and running custom containers. It will also explain how to use Swarm to orchestrate these containers together. This is a BYOL (bring your own laptop) session, so bring your Windows, OSX, or Linux laptop and be ready to dig into a tool that promises to be at the forefront of our industry for some time to come.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Latest content of this workshop is always at <a href="https://github.com/javaee-samples/docker-java" class="bare">https://github.com/javaee-samples/docker-java</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_environments">Setup Environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes the software needed for this workshop. This workshop is designed for a BYOL (Brying Your Own Laptop) style hands-on-lab.</p>
</div>
<div class="sect2">
<h3 id="_hardware">Hardware</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Operating System: Mac OS X (10.8+), Windows 7+, Ubuntu 12+, CentOS 7+, Fedora 21+</p>
</li>
<li>
<p>Memory: At least 4 GB+, preferred 8 GB</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_docker">Docker</h3>
<div class="sect3">
<h4 id="_docker_toolbox_or_packages">Docker Toolbox or Packages</h4>
<div class="paragraph">
<p>Docker runs natively on Linux. Because the Docker daemon uses Linux-specific kernel features, you can’t run Docker natively in OS X or Windows. Instead, you must use <code>docker-machine</code> to create and attach to a virtual machine (VM). This machine is a Linux VM that hosts Docker for you on your Mac or Windows. This can be easily installed using <a href="https://www.docker.com/docker-toolbox">Docker Toolbox</a>.</p>
</div>
<div class="paragraph">
<p>Follow the instructions to install Docker:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://github.com/docker/toolbox/releases/download/v1.9.0/DockerToolbox-1.9.0.pkg">Docker Tool Box 1.9.0 for Mac</a></p>
</li>
<li>
<p><a href="https://github.com/docker/toolbox/releases/download/v1.9.0/DockerToolbox-1.9.0.exe">Docker Toolbox 1.9.0 for Windows</a></p>
</li>
<li>
<p><a href="http://docs.docker.com/engine/installation/ubuntulinux/">Docker on Ubuntu</a></p>
</li>
<li>
<p><a href="http://docs.docker.com/engine/installation/centos/">Docker on Centos</a></p>
</li>
<li>
<p><a href="http://docs.docker.com/engine/installation/fedora/">Docker on Fedora</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Complete set of operating systems are listed at <a href="http://docs.docker.com/engine/installation/">Install Docker Engine</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_checkout_code_docker_java_code_workspace">Checkout <code>docker-java</code> workspace</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">git clone https://github.com/javaee-samples/docker-java</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pull_docker_images">Pull Docker images</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
For Mac and Windows, this commands need to be issued from the Docker shell or Command Prompt where <code>eval $(docker-machine env default)</code> command was issued. This command need to be issued in the <code>attendees</code> directory of <code>docker-java</code> workspace.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker-compose -f docker-compose-pull-images.yml pull</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_docker_host_mapping">Create Docker Host Mapping</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To make it easier to start/stop the containers, an entry is added into the host mapping table of your operating system. Find out the IP address of your machine:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker-machine ip default</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will provide the IP address associated with the Docker Machine created earlier.</p>
</div>
</li>
<li>
<p>Edit <code>/etc/hosts</code> (Mac OS or Linux) or <code>C:\Windows\System32\drivers\etc\hosts</code> (Windows) and add:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&lt;IP ADDRESS&gt;  dockerhost</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_optional_software">Optional Software</h4>
<div class="paragraph">
<p>The following software needs to be downloaded if you want to build/deploy a Java EE application.</p>
</div>
<div class="sect4">
<h5 id="_java_development_kit">Java Development Kit</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Java: <a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">Oracle JDK 8u65</a></p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_maven">Maven</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download Apache Maven from <a href="https://maven.apache.org/download.cgi" class="bare">https://maven.apache.org/download.cgi</a>.</p>
</li>
<li>
<p>Unzip to a directory of your choice and add it to the <code>PATH</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_wildfly">WildFly</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download WildFly 9.0 from <a href="http://download.jboss.org/wildfly/9.0.0.Final/wildfly-9.0.0.Final.zip" class="bare">http://download.jboss.org/wildfly/9.0.0.Final/wildfly-9.0.0.Final.zip</a>.</p>
</li>
<li>
<p>Install it by extracting the archive.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_jboss_developer_studio_9_0">JBoss Developer Studio 9.0</h5>
<div class="paragraph">
<p>To install JBoss Developer Studio stand-alone, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download <a href="http://tools.jboss.org/downloads/devstudio/mars/9.0.0.GA.html">9.0.0</a>.</p>
</li>
<li>
<p>Start the installer as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">java -jar &lt;JAR FILE NAME&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Follow the on-screen instructions to complete the installation process.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Kubernetes_Setup">Kubernetes</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download Vagrant from <a href="https://www.vagrantup.com/downloads.html" class="bare">https://www.vagrantup.com/downloads.html</a> and install.</p>
<div class="paragraph">
<p>Kubernetes requires Vagrant &gt;= 1.6.2. So if you have an older version then make sure you install the latest one.</p>
</div>
</li>
<li>
<p>If you&#8217;ve not installed Docker Toolbox, then you need to additionally download Virtual Box 5.0.8 from <a href="https://www.virtualbox.org/wiki/Downloads" class="bare">https://www.virtualbox.org/wiki/Downloads</a>.</p>
</li>
<li>
<p>Download Kubernetes (1.1.2) from <a href="https://github.com/kubernetes/kubernetes/releases/download/v1.1.2/kubernetes.tar.gz" class="bare">https://github.com/kubernetes/kubernetes/releases/download/v1.1.2/kubernetes.tar.gz</a>.</p>
</li>
<li>
<p>On Windows, Python interpreter needs to be installed and included in the <code>%PATH%</code>. Download from <a href="https://www.python.org/downloads/windows/" class="bare">https://www.python.org/downloads/windows/</a> and setup <code>%PATH%</code> in Control Panel.</p>
</li>
<li>
<p>Extract the archive and install it:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">export KUBERNETES_PROVIDER=vagrant
cd kubernetes
./cluster/kube-up.sh</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Vagrant provider should be included in the path. For example, for VirtualBox, <code>vboxmanage</code> command should work from the shell or command prompt where <code>./cluster/kube-up.sh</code> script is invoked.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you installed more than one Vagrant provider (such as VirtualBox and Parallels), Kubernetes will usually pick the appropriate one. You can override which one Kubernetes will use by setting the VAGRANT_DEFAULT_PROVIDER environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">export VAGRANT_DEFAULT_PROVIDER=virtualbox
export KUBERNETES_PROVIDER=vagrant
./cluster/kube-up.sh</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Docker_Basics">Docker Basics</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>PURPOSE</strong>: This chapter introduces the basic terminology of Docker.</p>
</div>
<div class="quoteblock">
<blockquote>
Docker is a platform for developers and sysadmins to develop, ship, and run applications. Docker lets you quickly assemble applications from components and eliminates the friction that can come when shipping code. Docker lets you get your code tested and deployed into production as fast as possible.
</blockquote>
<div class="attribution">
&#8212; docs.docker.com/
</div>
</div>
<div class="paragraph">
<p>Docker simplifies software delivery by making it easy to build and share images that contain your application’s entire environment, or <em>application operating system</em>.</p>
</div>
<div class="paragraph">
<p><strong>What does it mean by an application operating system ?</strong></p>
</div>
<div class="paragraph">
<p>Your application typically require a specific version of operating system, application server, JDK, database server, may require to tune the configuration files, and similarly multiple other dependencies. The application may need binding to specific ports and certain amount of memory. The components and configuration together required to run your application is what is referred to as application operating system.</p>
</div>
<div class="paragraph">
<p>You can certainly provide an installation script that will download and install these components. Docker simplifies this process by allowing to create an image that contains your application and infrastructure together, managed as one component. These images are then used to create Docker containers which run on the container virtualization platform, provided by Docker.</p>
</div>
<div class="paragraph">
<p><strong>Main Components of Docker</strong></p>
</div>
<div class="paragraph">
<p>Docker has three main components:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>Images</em> are the <strong>build component</strong> of Docker and are the read-only templates defining an application operating system.</p>
</li>
<li>
<p><em>Containers</em> are the <strong>run component</strong> of Docker and created from images. Containers can be run, started, stopped, moved, and deleted.</p>
</li>
<li>
<p>Images are stored, shared, and managed in a <em>registry</em> and are the <strong>distribution component</strong> of Docker. Docker Hub is a publicly available registry and is available at <a href="http://hub.docker.com" class="bare">http://hub.docker.com</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In order for these three components to work together, the <strong>Docker Daemon</strong> runs on a host machine and does the heavy lifting of building, running, and distributing Docker containers. In addition, the <strong>Client</strong> is a Docker binary which accepts commands from the user and communicates back and forth with the Daemon.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/docker-architecture.png" alt="docker architecture">
</div>
<div class="title">Figure 1. Docker architecture</div>
</div>
<div class="paragraph">
<p>The Client communicates with a Daemon that is either co-located on the same host or on a different host. Use the <code>pull</code> command on the Client to request the Daemon to pull an image from the registry. The Daemon then downloads the image from Docker Hub, or whichever registry is configured. Multiple images can be downloaded from the registry and installed on the Daemon host. To run an Image, use the <code>run</code> command on the Client to request the Daemon to create a container on-demand based on the image.</p>
</div>
<div class="paragraph">
<p><strong>How does a Docker Image work?</strong></p>
</div>
<div class="paragraph">
<p>We&#8217;ve already seen that Docker images are read-only templates from which Docker containers are launched. Each image consists of a series of layers. Docker makes use of union file systems to combine these layers into a single image. Union file systems allow files and directories of separate file systems, known as branches, to be transparently overlaid, forming a single coherent file system.</p>
</div>
<div class="paragraph">
<p>One of the reasons Docker is so lightweight is because of these layers. When you change a Docker image—for example, update an application to a new version— a new layer gets built. Thus, rather than replacing the whole image or entirely rebuilding, as you may do with a virtual machine, only that layer is added or updated. Now you don&#8217;t need to distribute a whole new image, just the update, making distributing Docker images faster and simpler.</p>
</div>
<div class="paragraph">
<p>Every image starts from a base image, for example <code>ubuntu</code>, a base Ubuntu image, or <code>fedora</code>, a base Fedora image. You can also use images of your own as the basis for a new image, for example if you have a base Apache image you could use this as the base of all your web application images.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
By default, Docker obtains these base images from Docker Hub.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Docker images are then built from these base images using a simple, descriptive set of steps we call instructions. Each instruction creates a new layer in our image. Instructions include actions like:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run a command</p>
</li>
<li>
<p>Add a file or directory</p>
</li>
<li>
<p>Create an environment variable</p>
</li>
<li>
<p>Run a process when launching a container</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These instructions are stored in a file called a Dockerfile. Docker reads this Dockerfile when you request a build of an image, executes the instructions, and returns a final image.</p>
</div>
<div class="paragraph">
<p><strong>How does a Container work?</strong></p>
</div>
<div class="paragraph">
<p>A container consists of an operating system, user-added files, and meta-data. As we&#8217;ve seen, each container is built from an image. That image tells Docker what the container holds, what process to run when the container is launched, and a variety of other configuration data. The Docker image is read-only. When Docker runs a container from an image, it adds a read-write layer on top of the image (using a union file system as we saw earlier) in which your application can then run.</p>
</div>
<div class="sect2">
<h3 id="_docker_machine">Docker Machine</h3>
<div class="paragraph">
<p>Machine makes it really easy to create Docker hosts on your computer, on cloud providers and inside your own data center. It creates servers, installs Docker on them, then configures the Docker client to talk to them.</p>
</div>
<div class="paragraph">
<p>Once your Docker host has been created, it then has a number of commands for managing containers:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start, stop, restart container</p>
</li>
<li>
<p>Upgrade Docker</p>
</li>
<li>
<p>Configure the Docker client to talk to a host</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Docker Machine was already installed as part of Docker Toolbox during the setup.</p>
</div>
<div class="paragraph">
<p>Find out more details at <a href="https://docs.docker.com/machine/">Docker Machine Website</a>.</p>
</div>
<div class="paragraph">
<p>Open Docker shell, check if docker machine is working:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker-machine -v</pre>
</div>
</div>
<div class="paragraph">
<p>It shows the output:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker-machine version 0.5.0 (04cfa58)</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The exact version may differ based upon how recently the installation was performed.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_docker_client">Docker Client</h3>
<div class="paragraph">
<p>The client communicates with the demon process on your host and let&#8217;s you work with images and containers.</p>
</div>
<div class="paragraph">
<p>Check if your client is working using the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker -v</pre>
</div>
</div>
<div class="paragraph">
<p>It shows the output:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Docker version 1.9.0, build 76d6bc9</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The exact version may differ based upon how recently the installation was performed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The most important options you&#8217;ll be using frequently are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>run</code> - runs a container</p>
</li>
<li>
<p><code>ps</code>- lists containers</p>
</li>
<li>
<p><code>stop</code> - stops a container</p>
</li>
<li>
<p><code>rm</code> - Removes a container</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Get a full list of available commands with</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker</pre>
</div>
</div>
<div class="paragraph">
<p>A more commonly used list of commands is available at <a href="#Common_Docker_Commands">Common Docker Commands</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_verify_docker_configuration">Verify Docker Configuration</h3>
<div class="paragraph">
<p>Open Docker shell, check if your Docker Host is running:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker-machine ls</pre>
</div>
</div>
<div class="paragraph">
<p>You should see the output similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">NAME        ACTIVE   DRIVER       STATE     URL                         SWARM
default     *        virtualbox   Running   tcp://192.168.99.100:2376</code></pre>
</div>
</div>
<div class="paragraph">
<p>This machine is shown in &#8220;Running&#8221; state. If the machine state is stopped, start it with:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker-machine start default</pre>
</div>
</div>
<div class="paragraph">
<p>After it is started you can find out IP address of your Docker Host with:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker-machine ip default</pre>
</div>
</div>
<div class="paragraph">
<p>We already did this during the setup document, remember? So, this is a good chance to check, if you already added this IP to your hosts file.</p>
</div>
<div class="paragraph">
<p>Type:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ping dockerhost</pre>
</div>
</div>
<div class="paragraph">
<p>and see if this resolves to the IP address that the docker-machine command printed out. You should see an output as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&gt; ping dockerhost
PING dockerhost (192.168.99.101): 56 data bytes
64 bytes from 192.168.99.101: icmp_seq=0 ttl=64 time=0.394 ms
64 bytes from 192.168.99.101: icmp_seq=1 ttl=64 time=0.387 ms</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it does, you&#8217;re ready to start the workshop.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_an_image">Build an Image</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>PURPOSE</strong>: This chapter explains how to create a Docker image.</p>
</div>
<div class="paragraph">
<p>As explained in <a href="#Docker_Basics">Docker Basics</a>, Docker image is the <strong>build component</strong> of Docker and a read-only template of application operating system.</p>
</div>
<div class="sect2">
<h3 id="_dockerfile">Dockerfile</h3>
<div class="paragraph">
<p>Docker build images by reading instructions from a <em>Dockerfile</em>. A <em>Dockerfile</em> is a text document that contains all the commands a user could call on the command line to assemble an image. <code>docker build</code> command uses this file and executes all the commands in succession to create an image.</p>
</div>
<div class="paragraph">
<p><code>build</code> command is also passed a context that is used during image creation. This context can be a path on your local filesystem or a URL to a Git repository.</p>
</div>
<div class="paragraph">
<p><em>Dockerfile</em> is usually called <em>Dockerfile</em>. The complete list of commands that can be specified in this file are explained at <a href="https://docs.docker.com/reference/builder/" class="bare">https://docs.docker.com/reference/builder/</a>. The common commands are listed below:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Common commands for Dockerfile</caption>
<colgroup>
<col style="width: 11%;">
<col style="width: 44%;">
<col style="width: 44%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Command</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FROM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">First non-comment instruction in <em>Dockerfile</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FROM ubuntu</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">COPY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Copies mulitple source files from the context to the file system of the container at the specified path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>COPY .bash_profile /home</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ENV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the environment variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ENV HOSTNAME=test</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RUN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executes a command</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>RUN apt-get update</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CMD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defaults for an executing container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CMD ["/bin/echo", "hello world"]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXPOSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Informs the network ports that the container will listen on</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EXPOSE 8093</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_create_your_first_docker_image">Create your first Docker image</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new directory.</p>
</li>
<li>
<p>Create a new text file, name it <em>Dockerfile</em>, and use the following contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">FROM ubuntu

CMD ["/bin/echo", "hello world"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This image uses <code>ubuntu</code> as the base image. <code>CMD</code> command defines the command that needs to run. It provides a different entry point of <code>/bin/echo</code> and gives the argument &#8220;hello world&#8221;.</p>
</div>
</li>
<li>
<p>Build this image:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">&gt; docker build -t helloworld .
Sending build context to Docker daemon 2.048 kB
Step 0 : FROM ubuntu
Pulling repository docker.io/library/ubuntu
a5a467fddcb8: Download complete
3fd0c2ae8ed2: Download complete
9e19ac89d27c: Download complete
ac65c371c3a5: Download complete
Status: Downloaded newer image for ubuntu:latest
 ---&gt; a5a467fddcb8
Step 1 : CMD /bin/echo hello world
 ---&gt; Running in 132bb0bf823f
 ---&gt; e81a394f71e3
Removing intermediate container 132bb0bf823f
Successfully built e81a394f71e3</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>.</code> in this command is the context for <code>docker build</code>.</p>
</div>
</li>
<li>
<p>List the images available:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">&gt; docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
helloworld          latest              9c0e7b56cbee        13 minutes ago      187.9 MB</code></pre>
</div>
</div>
</li>
<li>
<p>Run the container:</p>
<div class="literalblock">
<div class="content">
<pre>docker run helloworld</pre>
</div>
</div>
<div class="paragraph">
<p>to see the output:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>hello world</pre>
</div>
</div>
</li>
<li>
<p>Change the base image from <code>ubuntu</code> to <code>busybox</code> in <code>Dockerfile</code>. Build the image again:</p>
<div class="literalblock">
<div class="content">
<pre>docker build -t helloworld2 .</pre>
</div>
</div>
<div class="paragraph">
<p>and view the images as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">&gt; docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
helloworld          latest              e81a394f71e3        26 minutes ago      187.9 MB
helloworld2         latest              c458787fadcf        3 seconds ago       1.113 MB
ubuntu              latest              a5a467fddcb8        2 days ago          187.9 MB
busybox             latest              3d5bcd78e074        4 days ago          1.113 MB</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_wildfly_image">WildFly Image</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new directory.</p>
</li>
<li>
<p>Create a new text file, name it <em>Dockerfile</em>, and use the following contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">FROM jboss/wildfly</code></pre>
</div>
</div>
</li>
<li>
<p>Build the image:</p>
<div class="literalblock">
<div class="content">
<pre>docker build -t mywildfly .</pre>
</div>
</div>
</li>
<li>
<p>Run the container:</p>
<div class="literalblock">
<div class="content">
<pre>docker run -it mywildfly</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
On Windows, you may have to use <code>winpty</code> so that TTY can be attached. The updated command will be <code>winpty docker run -it mywildfly</code>.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_java_ee_7_application_image">Java EE 7 Application Image</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new directory.</p>
</li>
<li>
<p>Create a new text file, name it <em>Dockerfile</em>, and use the following contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">FROM jboss/wildfly <b class="conum">(1)</b>

CMD ["/opt/jboss/wildfly/bin/standalone.sh", "-c", "standalone-full.xml", "-b", "0.0.0.0"] <b class="conum">(2)</b>

RUN curl -L https://github.com/javaee-samples/javaee7-hol/raw/master/solution/movieplex7-1.0-SNAPSHOT.war -o /opt/jboss/wildfly/standalone/deployments/movieplex7-1.0-SNAPSHOT.war <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p>Three things in this image:</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Uses &#8220;jboss/wildfly&#8221; as the base image</p>
</li>
<li>
<p>Starts WildFly application server in Full Platform mode</p>
</li>
<li>
<p>Copies the WAR file from from a URL to the deployment directory of WildFly</p>
</li>
</ol>
</div>
</li>
<li>
<p>Build the image:</p>
<div class="literalblock">
<div class="content">
<pre>docker build -t movieplex .</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_dockerfile_command_design_patterns">Dockerfile Command Design Patterns</h3>
<div class="sect3">
<h4 id="_difference_between_cmd_and_entrypoint">Difference between CMD and ENTRYPOINT</h4>
<div class="paragraph">
<p><strong>TL;DR</strong> <code>CMD</code> will work for most of the cases.</p>
</div>
<div class="paragraph">
<p>Default entry point for a container is <code>/bin/sh</code>, the default shell.</p>
</div>
<div class="paragraph">
<p>Running a container as <code>docker run -it ubuntu</code> uses that command and starts the default shell. The output is shown as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">&gt; docker run -it ubuntu
root@88976ddee107:/#</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ENTRYPOINT</code> allows to override the entry point to some other command, and even customize it. For example, a container can be started as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">&gt; docker run -it --entrypoint=/bin/cat ubuntu /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
. . .</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command overrides the entry point to the container to <code>/bin/cat</code>. The argument(s) passed to the CLI are used by the entry point.</p>
</div>
</div>
<div class="sect3">
<h4 id="_difference_between_add_and_copy">Difference between ADD and COPY</h4>
<div class="paragraph">
<p><strong>TL;DR</strong> <code>COPY</code> will work for most of the cases.</p>
</div>
<div class="paragraph">
<p><code>ADD</code> has all capabilities of <code>COPY</code> and has the following additional features:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allows tar file auto-extraction in the image, for example, <code>ADD app.tar.gz /opt/var/myapp</code>.</p>
</li>
<li>
<p>Allows files to be downloaded from a remote URL. However, the downloaded files will become part of the image. This causes the image size to bloat. So its recommended to use <code>curl</code> or <code>wget</code> to download the archive explicitly, extract, and remove the archive.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_import_and_export_images">Import and export images</h4>
<div class="paragraph">
<p>Docker images can be saved using <code>save</code> command to a .tar file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker save helloworld &gt; helloworld.tar</pre>
</div>
</div>
<div class="paragraph">
<p>These tar files can then be imported using <code>load</code> command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker load -i helloworld.tar</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_a_container">Run a Container</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first step in running any application on Docker is to run a container from an image. There are plenty of images available from the official Docker registry (aka <a href="https://hub.docker.com">Docker Hub</a>). To run any of them, you just have to ask the Docker Client to run it. The client will check if the image already exists on Docker Host. If it exists then it&#8217;ll run it, otherwise the host will download the image and then run it.</p>
</div>
<div class="sect2">
<h3 id="_pull_image">Pull Image</h3>
<div class="paragraph">
<p>Let&#8217;s first check, if any images are available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker images</code></pre>
</div>
</div>
<div class="paragraph">
<p>At first, this list is empty. Now, let&#8217;s get a vanilla <code>jboss/wildfly</code> image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker pull jboss/wildfly</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, docker images are retrieved from <a href="https://hub.docker.com/">Docker Hub</a>.</p>
</div>
<div class="paragraph">
<p>You can see, that Docker is downloading the image with it&#8217;s different layers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>In a traditional Linux boot, the Kernel first mounts the root File System as read-only, checks its integrity, and then switches the whole rootfs volume to read-write mode.
When Docker mounts the rootfs, it starts read-only, as in a traditional Linux boot, but then, instead of changing the file system to read-write mode, it takes advantage of a union mount to add a read-write file system over the read-only file system. In fact there may be multiple read-only file systems stacked on top of each other. Consider each one of these file systems as a layer.</p>
</div>
<div class="paragraph">
<p>At first, the top read-write layer has nothing in it, but any time a process creates a file, this happens in the top layer. And if something needs to update an existing file in a lower layer, then the file gets copied to the upper layer and changes go into the copy. The version of the file on the lower layer cannot be seen by the applications anymore, but it is there, unchanged.</p>
</div>
<div class="paragraph">
<p>We call the union of the read-write layer and all the read-only layers a <em>union file system</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/plain-wildfly0.png" alt="plain wildfly0">
</div>
<div class="title">Figure 2. Docker Layers</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In our particular case, the <a href="https://github.com/jboss-dockerfiles/wildfly/blob/master/Dockerfile">jboss/wildfly</a> image extends the <a href="https://github.com/jboss-dockerfiles/base/blob/master/Dockerfile">jboss/base-jdk:7</a> image which adds the OpenJDK distribution on top of the <a href="https://github.com/jboss-dockerfiles/base/blob/master/Dockerfile">jboss/base</a> image.
The base image is used for all JBoss community images. It provides a base layer that includes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A jboss user (uid/gid 1000) with home directory set to <code>/opt/jboss</code></p>
</li>
<li>
<p>A few tools that may be useful when extending the image or installing software, like unzip.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The &#8220;jboss/base-jdk:7&#8221; image adds:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>OpenJDK 7 distribution</p>
</li>
<li>
<p>Adds a <code>JAVA_HOME</code> environment variable</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the download is done, you can list the images again and will see the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
jboss/wildfly       latest              e908c8c95a8b        5 days ago          581.5 MB</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_run_container">Run Container</h3>
<div class="sect3">
<h4 id="_interactive_container">Interactive Container</h4>
<div class="paragraph">
<p>Run WildFly container in an interactive mode.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run -it jboss/wildfly</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will show the output as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">=========================================================================

  JBoss Bootstrap Environment

  JBOSS_HOME: /opt/jboss/wildfly

  JAVA: /usr/lib/jvm/java/bin/java

  JAVA_OPTS:  -server -XX:+UseCompressedOops  -server -XX:+UseCompressedOops -Xms64m -Xmx512m -XX:MaxPermSize=256m -Djava.net.preferIPv4Stack=true -Djboss.modules.system.pkgs=org.jboss.byteman -Djava.awt.headless=true

=========================================================================

OpenJDK 64-Bit Server VM warning: ignoring option MaxPermSize=256m; support was removed in 8.0
00:44:43,895 INFO  [org.jboss.modules] (main) JBoss Modules version 1.4.3.Final
00:44:44,184 INFO  [org.jboss.msc] (main) JBoss MSC version 1.2.6.Final
00:44:44,267 INFO  [org.jboss.as] (MSC service thread 1-2) WFLYSRV0049: WildFly Full 9.0.0.Final (WildFly Core 1.0.0.Final) starting

. . .

00:46:54,241 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0060: Http management interface listening on http://127.0.0.1:9990/management
00:46:54,243 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0051: Admin console listening on http://127.0.0.1:9990
00:46:54,250 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: WildFly Full 9.0.0.Final (WildFly Core 1.0.0.Final) started in 4256ms - Started 203 of 379 services (210 services are lazy, passive or on-demand)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This shows that the server started correctly, congratulations!</p>
</div>
<div class="paragraph">
<p>By default, Docker runs in the foreground. <code>-i</code> allows to interact with the STDIN and <code>-t</code> attach a TTY to the process. Switches can be combined together and used as <code>-it</code>.</p>
</div>
<div class="paragraph">
<p>Hit Ctrl+C to stop the container.</p>
</div>
</div>
<div class="sect3">
<h4 id="_detached_container">Detached Container</h4>
<div class="paragraph">
<p>Restart the container in detached mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run -d jboss/wildfly
972f51cc8422eec0a7ea9a804a55a2827b5537c00a6bfd45f8646cb764bc002a</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>-d</code>, instead of <code>-it</code>, runs the container in detached mode.</p>
</div>
<div class="paragraph">
<p>The output is the unique id assigned to the container. Check the logs as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&gt; docker logs 972f51cc8422eec0a7ea9a804a55a2827b5537c00a6bfd45f8646cb764bc002a
=========================================================================

  JBoss Bootstrap Environment

  JBOSS_HOME: /opt/jboss/wildfly

. . .</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can check it by issuing the <code>docker ps</code> command which retrieves the images process which are running and the ports engaged by the process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&gt; docker ps
CONTAINER ID        IMAGE                                 COMMAND                CREATED             STATUS              PORTS                    NAMES
922abbb9c63a        jboss/wildfly       "/opt/jboss/wildfly/   3 seconds ago       Up 2 seconds        8080/tcp            desperate_lovelace</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also try <code>docker ps -a</code> to see all the containers on this machine.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_run_container_with_default_port">Run Container with Default Port</h3>
<div class="paragraph">
<p>Startup log of the server shows that the server is located in the <code>/opt/jboss/wildfly</code>. It also shows that the public interfaces are bound to the <code>0.0.0.0</code> address while the admin interfaces are bound just to <code>localhost</code>. This information will be useful to learn how to customize the server.</p>
</div>
<div class="paragraph">
<p><code>docker-machine ip &lt;machine-name&gt;</code> gives us the Docker Host IP address and this was already added to the hosts file. So, we can give it another try by accessing: <a href="http://dockerhost:8080" class="bare">http://dockerhost:8080</a>. However, this will not work either.</p>
</div>
<div class="paragraph">
<p>If you want containers to accept incoming connections, you will need to provide special options when invoking <code>docker run</code>. The container, we just started, can&#8217;t be accessed by our browser. We need to stop it again and restart with different options.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker stop `docker ps | grep wildfly | awk '{print $1}'`</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart the container as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run -d -P jboss/wildfly</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>-P</code> map any exposed ports inside the image to a random port on Docker host. This can be verified as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&gt; docker ps
CONTAINER ID        IMAGE                                 COMMAND                CREATED             STATUS              PORTS                     NAMES
63a69bff9c69        jboss/wildfly       "/opt/jboss/wildfly/   14 seconds ago      Up 13 seconds       0.0.0.0:32768-&gt;8080/tcp   kickass_bohr</code></pre>
</div>
</div>
<div class="paragraph">
<p>The port mapping is shown in the <code>PORTS</code> column. Access the WildFly server at <a href="http://dockerhost:32768" class="bare">http://dockerhost:32768</a>. Make sure to use the correct port number as shown in your case.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Exact port number may be different in your case.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_run_container_with_specified_port">Run Container with Specified Port</h3>
<div class="paragraph">
<p>Lets stop the previously running container as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker stop `docker ps | grep wildfly | awk '{print $1}'`</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart the container as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run -it -p 8080:8080 jboss/wildfly</code></pre>
</div>
</div>
<div class="paragraph">
<p>The format is <code>-p hostPort:containerPort</code>. This option maps container ports to host ports and allows other containers on our host to access them.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Docker Port Mapping</div>
<div class="paragraph">
<p>Port exposure and mapping are the keys to successful work with Docker.
See more about networking on the Docker website <a href="https://docs.docker.com/articles/networking/">Advanced Networking</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we&#8217;re ready to test <a href="http://dockerhost:8080" class="bare">http://dockerhost:8080</a> again. This works with the exposed port, as expected.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/plain-wildfly1.png" alt="plain wildfly1">
</div>
<div class="title">Figure 3. Welcome WildFly</div>
</div>
</div>
<div class="sect2">
<h3 id="_stop_container">Stop Container</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Stop a specific container:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker stop &lt;CONTAINER ID&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Stop all the running containers</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker stop $(docker ps -q)</code></pre>
</div>
</div>
</li>
<li>
<p>Stop only the exited containers</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker ps -a -f "exited=-1"</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_remove_container">Remove Container</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Remove a specific container:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker rm 0bc123a8ece0</code></pre>
</div>
</div>
</li>
<li>
<p>Remove containers meeting a regular expression</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker ps -a | grep wildfly | awk '{print $1}' | xargs docker rm</code></pre>
</div>
</div>
</li>
<li>
<p>Remove all containers, without any criteria</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker rm $(docker ps -aq)</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Enabling_WildFly_Administration">Enable WildFly Administration</h3>
<div class="paragraph">
<p>Default WildFly image exposes only port 8080 and thus is not available for administration using either the CLI or Admin Console. Lets expose the ports in different ways.</p>
</div>
<div class="sect3">
<h4 id="_default_port_mapping">Default Port Mapping</h4>
<div class="paragraph">
<p>The following command will override the default command in Docker file, start WildFly, and bind application and management port to all network interfaces.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run -P -d jboss/wildfly /opt/jboss/wildfly/bin/standalone.sh -b 0.0.0.0 -bmanagement 0.0.0.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Accessing WildFly Administration Console require a user in administration realm. A pre-created image, with appropriate username/password credentials, is used to start WildFly as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run -P -d arungupta/wildfly-management</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>-P</code> map any exposed ports inside the image to a random port on Docker host.</p>
</div>
<div class="paragraph">
<p>Look at the exposed ports as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker ps
CONTAINER ID        IMAGE                                           COMMAND                CREATED             STATUS              PORTS                                              NAMES
af7d6914a1f9        arungupta/wildfly-management   "/opt/jboss/wildfly/   2 seconds ago       Up 1 seconds        0.0.0.0:32770-&gt;8080/tcp, 0.0.0.0:32769-&gt;9990/tcp   happy_bardeen</code></pre>
</div>
</div>
<div class="paragraph">
<p>Look for the host port that is mapped in the container, <code>32769</code> in this case. Access the admin console at <a href="http://dockerhost:32769" class="bare">http://dockerhost:32769</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Exact port number may be different in your case.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The username/password credentials are:</p>
</div>
<table id="WildFly_Administration_Credentials" class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">admin</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">docker#admin</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This shows the admin console as:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/wildfly-admin-console.png" alt="wildfly admin console">
</div>
<div class="title">Figure 4. Welcome WildFly</div>
</div>
<div class="sect4">
<h5 id="_additional_ways_to_find_port_mapping">Additional Ways To Find Port Mapping</h5>
<div class="paragraph">
<p>The exact mapped port can also be found as:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using <code>docker port</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker port 6f610b310a46</code></pre>
</div>
</div>
<div class="paragraph">
<p>to see the output as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">0.0.0.0:32769-&gt;8080/tcp
0.0.0.0:32770-&gt;9990/tcp</code></pre>
</div>
</div>
</li>
<li>
<p>Using <code>docker inspect</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker inspect --format='{{(index (index .NetworkSettings.Ports "9990/tcp") 0).HostPort}}' &lt;CONTAINER ID&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Management_Fixed_Port_Mapping">Fixed Port Mapping</h4>
<div class="paragraph">
<p>This management image can also be started with a pre-defined port mapping as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run -p 8080:8080 -p 9990:9990 -d arungupta/wildfly-management</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, Docker port mapping will be shown as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">8080/tcp -&gt; 0.0.0.0:8080
9990/tcp -&gt; 0.0.0.0:9990</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="JavaEE7_PreBuilt_WAR">Deploy Java EE 7 Application (Pre-Built WAR)</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/javaee-samples/javaee7-hol">Java EE 7 Movieplex</a> is a standard multi-tier enterprise application that shows design patterns and anti-patterns for a typical Java EE 7 application.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/javaee7-hol.png" alt="javaee7 hol">
</div>
<div class="title">Figure 5. Java EE 7 Application Architecture</div>
</div>
<div class="paragraph">
<p>Pull the Docker image that contains WildFly and pre-built Java EE 7 application WAR file as shown:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker pull arungupta/javaee7-hol</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/arun-gupta/docker-images/blob/master/javaee7-hol/Dockerfile">javaee7-hol Dockerfile</a> is based on <code>jboss/wildfly</code> and adds the movieplex7 application as war file.</p>
</div>
<div class="paragraph">
<p>Run it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run -it -p 8080:8080 arungupta/javaee7-hol</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the application in action at <a href="http://dockerhost:8080/movieplex7/" class="bare">http://dockerhost:8080/movieplex7/</a>. The output is shown:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/javaee7-movieplex7.png" alt="javaee7 movieplex7">
</div>
<div class="title">Figure 6. Java EE 7 Application Output</div>
</div>
<div class="paragraph">
<p>This uses an in-memory database with WildFly application server as shown in the image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/javaee7-hol-in-memory-database.png" alt="javaee7 hol in memory database">
</div>
<div class="title">Figure 7. In-memory Database</div>
</div>
<div class="paragraph">
<p>Only two changes are required to the standard <code>jboss/wildfly</code> image:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>By default, WildFly starts in Web platform. This Java EE 7 application uses some capabilities from the Full Platform and so WildFly is started in that mode instead as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">CMD ["/opt/jboss/wildfly/bin/standalone.sh", "-c", "standalone-full.xml", "-b", "0.0.0.0"]</code></pre>
</div>
</div>
</li>
<li>
<p>WAR file is copied to the <code>standalone/deployments</code> directory as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">RUN curl -L https://github.com/javaee-samples/javaee7-hol/raw/master/solution/movieplex7-1.0-SNAPSHOT.war -o /opt/jboss/wildfly/standalone/deployments/movieplex7-1.0-SNAPSHOT.war</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="JavaEE7_Container_Linking">Deploy Java EE 7 Application (Container Linking)</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#JavaEE7_PreBuilt_WAR">Deploy Java EE 7 Application (Pre-Built WAR)</a> explained how to use an in-memory database with the application server. This gets you started rather quickly but becomes a bottleneck soon as the database is only in-memory. This means that any changes made to your schema and data are lost when the application server shuts down. In this case, you need to use a database server that resides outside the application server. For example, MySQL as the database server and WildFly as the application server.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/javaee7-hol-container-linking.png" alt="javaee7 hol container linking">
</div>
<div class="title">Figure 8. Two Containers On Same Docker Host</div>
</div>
<div class="paragraph">
<p>This section will show how <a href="https://docs.docker.com/userguide/dockerlinks/">Docker Container Linking</a> can be used to connect to a service running inside a Docker container via a network port.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start MySQL server as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run --name mysqldb -e MYSQL_USER=mysql -e MYSQL_PASSWORD=mysql -e MYSQL_DATABASE=sample -e MYSQL_ROOT_PASSWORD=supersecret -p 3306:3306 -d mysql</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>-e</code> define environment variables that are read by the database at startup and allow us to access the database with this user and password.</p>
</div>
</li>
<li>
<p>Start WildFly and deploy Java EE 7 application as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run -it --name mywildfly --link mysqldb:db -p 8080:8080 arungupta/wildfly-mysql-javaee7</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>--link</code> takes two parameters - first is name of the container we&#8217;re linking to and second is the alias for the link name.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Container Linking</div>
<div class="paragraph">
<p>Creating a link between two containers creates a conduit between a source container and a target container and securely transfer information about source container to target container.</p>
</div>
<div class="paragraph">
<p>In our case, target container (WildFly) can see information about source container (MySQL). When containers are linked, information about a source container can be sent to a recipient container. This allows the recipient to see selected data describing aspects of the source container. For example, IP address of MySQL server is expoed at $DB_PORT_3306_TCP_ADDR and port of MySQL server is exposed at $DB_PORT_3306_TCP_PORT. These are then used to create the JDBC resource.</p>
</div>
<div class="paragraph">
<p>See more about container communication on the Docker website <a href="https://docs.docker.com/userguide/dockerlinks/">Linking Containers Together</a></p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>See the output as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&gt; curl http://dockerhost:8080/employees/resources/employees
&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;&lt;collection&gt;&lt;employee&gt;&lt;id&gt;1&lt;/id&gt;&lt;name&gt;Penny&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;2&lt;/id&gt;&lt;name&gt;Sheldon&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;3&lt;/id&gt;&lt;name&gt;Amy&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;4&lt;/id&gt;&lt;name&gt;Leonard&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;5&lt;/id&gt;&lt;name&gt;Bernadette&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;6&lt;/id&gt;&lt;name&gt;Raj&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;7&lt;/id&gt;&lt;name&gt;Howard&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;8&lt;/id&gt;&lt;name&gt;Priya&lt;/name&gt;&lt;/employee&gt;&lt;/collection&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_and_deploy_java_ee_7_application">Build and Deploy Java EE 7 Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/javaee-samples/javaee7-simple-sample">Java EE 7 Simple Sample</a> is a trivial Java EE 7 sample application.</p>
</div>
<div class="sect2">
<h3 id="Build_Application">Build Application</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone the repo:</p>
<div class="literalblock">
<div class="content">
<pre>git clone https://github.com/javaee-samples/javaee7-simple-sample.git</pre>
</div>
</div>
</li>
<li>
<p>Build the application:</p>
<div class="literalblock">
<div class="content">
<pre>mvn clean package</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_start_application_server">Start Application Server</h3>
<div class="paragraph">
<p>Start WildFly server as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run --name wildfly -d -p 8080:8080 -v /Users/youruser/javaee7-simple-sample/target:/opt/jboss/wildfly/standalone/deployments/:rw jboss/wildfly</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure to replace <code>/Users/youruser/javaee7-simple-sample/target</code> to the target directory of your checked out project.</p>
</div>
<div class="paragraph">
<p>This command starts a container named &#8220;wildfly&#8221;.</p>
</div>
<div class="paragraph">
<p>The <code>-v</code> flag maps a directory from the host into the container. This will be the directory to put the deployments. <code>rw</code> ensures that the Docker container can write to it.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Windows users, please make sure to use <code>-v /c/Users/</code> notation for drive letters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Check logs to verify if the server has started.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker logs -f wildfly</code></pre>
</div>
</div>
<div class="paragraph">
<p>Access <a href="http://dockerhost:8080" class="bare">http://dockerhost:8080</a> in your browser to make sure the instance is up and running.</p>
</div>
<div class="paragraph">
<p>Now you&#8217;re ready to deploy the application for the first time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configure_jboss_developer_studio">Configure JBoss Developer Studio</h3>
<div class="paragraph">
<p>Start JBoss Developer Studio, if not already started.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Select &#8216;Servers&#8217; tab, create a new server adapter</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds1.png" alt="jbds1">
</div>
<div class="title">Figure 9. Server adapter</div>
</div>
</li>
<li>
<p>Assign an existing or create a new WildFly 9.0.0 runtime (changed properties are highlighted.)</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds2.png" alt="jbds2">
</div>
<div class="title">Figure 10. WildFly Runtime Properties</div>
</div>
</li>
<li>
<p>If a new runtime needs to be created, pick the directory for WildFly 9.0.0:</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds3.png" alt="jbds3">
</div>
<div class="title">Figure 11. WildFly 9.0.0.Final Runtime</div>
</div>
<div class="paragraph">
<p>Click on &#8216;Finish&#8217;.</p>
</div>
</li>
<li>
<p>Double-click on the newly selected server to configure server properties:</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds4.png" alt="jbds4">
</div>
<div class="title">Figure 12. Server properties</div>
</div>
<div class="paragraph">
<p>The host name is specified to &#8216;dockerhost&#8217;. Two properties on the left are automatically propagated from the previous dialog. Additional two properties on the right side are required to disable to keep deployment scanners in sync with the server.</p>
</div>
</li>
<li>
<p>Specify a custom deployment folder on Deployment tab of Server Editor</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds5.png" alt="jbds5">
</div>
<div class="title">Figure 13. Custom deployment folder</div>
</div>
</li>
<li>
<p>Right-click on the newly created server adapter and click &#8216;Start&#8217;.</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds6.png" alt="jbds6">
</div>
<div class="title">Figure 14. Started server</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_application_using_shared_volumes">Deploy Application Using Shared Volumes</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Import javaee7-simple-sample application source code using Import &#8594; Existing Maven Projects.</p>
</li>
<li>
<p>Right-click on the project, select &#8216;Run on Server&#8217; and chose the previously created server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The project runs and displays the start page of the application.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds7.png" alt="jbds7">
</div>
<div class="title">Figure 15. Start Server</div>
</div>
<div class="paragraph">
<p>Congratulations!</p>
</div>
<div class="paragraph">
<p>You&#8217;ve deployed your first application to WildFly running in a Docker container from JBoss Developer Studio.</p>
</div>
<div class="paragraph">
<p>Stop WildFly container when you&#8217;re done.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker stop wildfly</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_application_using_cli">Deploy Application Using CLI</h3>
<div class="paragraph">
<p>The Command Line Interface (CLI) is a tool for connecting to WildFly instances to manage all tasks from command line environment. Some of the tasks that you can do using the CLI are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy/Undeploy web application in standalone/Domain Mode.</p>
</li>
<li>
<p>View all information about the deployed application on runtime.</p>
</li>
<li>
<p>Start/Stop/Restart Nodes in respective mode i.e. Standalone/Domain.</p>
</li>
<li>
<p>Adding/Deleting resource or subsystems to servers.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Lets use the CLI to deploy javaee7-simple-sample to WildFly running in the container.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>CLI needs to be locally installed and comes as part of WildFly. This should be available in the previously downloaded WildFly. Unzip into a folder of your choice (e.g. <code>/Users/arungupta/tools/</code>). This will create <code>wildfly-9.0.0.Final</code> directory here. This folder is referred to $WIDLFY_HOME from here on. Make sure to add the <code>/Users/arungupta/tools/wildfly-9.0.0.Final/bin</code> to your $PATH.</p>
</li>
<li>
<p>Run the &#8220;wildfly-management&#8221; image with fixed port mapping as explained in <a href="#Management_Fixed_Port_Mapping">Fixed Port Mapping</a>.</p>
</li>
<li>
<p>Run the <code>jboss-cli</code> command and connect to the WildFly instance.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">jboss-cli.sh --controller=dockerhost:9990  -u=admin -p=docker#admin -c</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will show the output as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">[standalone@dockerhost:9990 /]</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the application as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">deploy &lt;javaee7-simple-sample PATH&gt;target/javaee7-simple-sample-1.10.war --force</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now you&#8217;ve sucessfully used the CLI to remote deploy the Java EE 7 sample application to WildFly running as docker container.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_application_using_web_console">Deploy Application Using Web Console</h3>
<div class="paragraph">
<p>WildFly comes with a web-based administration console. It also relies on the same management APIs that are used by JBoss Developer Tools and the CLI. It provides a simple and easy to use web-based console to manage WildFly instance. For a Docker image, it needs to be explicitly enabled as explained in <a href="#Enabling_WildFly_Administration">Enable WildFly Administration</a>. Once enabled, it can be accessed at <a href="http://dockerhost:9990" class="bare">http://dockerhost:9990</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/console1.png" alt="console1">
</div>
<div class="title">Figure 16. WildFly Web Console</div>
</div>
<div class="paragraph">
<p>Username and password credentials are shown in <a href="#WildFly_Administration_Credentials">[WildFly_Administration_Credentials]</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You may like to stop and remove the Docker container running WildFly. This can be done as <code>docker ps -a | grep wildfly | awk '{print $1}' | xargs docker rm -f</code>.</p>
</div>
<div class="paragraph">
<p>Start a new container as <code>docker run -d --name wildfly -p 8080:8080 -p 9990:9990 arungupta/wildfly-management</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Deploy the application using the console with the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Go to &#8216;Deployments&#8217; tab.</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/wildfly9-deployments-tab.png" alt="wildfly9 deployments tab">
</div>
<div class="title">Figure 17. Deployments tab in WildFly Web Console</div>
</div>
</li>
<li>
<p>Click on &#8216;Add&#8217; button.</p>
</li>
<li>
<p>On &#8216;Add Deployment&#8217; screen, take the default of &#8216;Upload a new deployment&#8217; and click &#8216;Next&gt;&gt;&#8217;.</p>
</li>
<li>
<p>Click on &#8216;Choose File&#8217;, select <code>&lt;javaee7-simple-sample PATH&gt;/javaee7-simple-sample.war</code> file on your computer. This would be <code>javaee7-simple-sample/target/javaee7-simple-sample.war</code> from <a href="#Build_Application">Build Application</a>.</p>
</li>
<li>
<p>Click on &#8216;Next&gt;&gt;&#8217;.</p>
</li>
<li>
<p>Select &#8216;Enable&#8217; checkbox.</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/wildfly9-add-deployments.png" alt="wildfly9 add deployments">
</div>
<div class="title">Figure 18. Enable a deployment</div>
</div>
</li>
<li>
<p>Click &#8216;Finish&#8217;.</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/wildfly9-javaee7-simple-sample-deployed.png" alt="wildfly9 javaee7 simple sample deployed">
</div>
<div class="title">Figure 19. Java EE 7 Simple Sample Deployed</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This will complete the deployment of the Java EE 7 application using Web Console. The output can be seen out <a href="http://dockerhost:8080/javaee7-simple-sample" class="bare">http://dockerhost:8080/javaee7-simple-sample</a> and looks like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/wildfly9-javaee7-simple-sample-output.png" alt="wildfly9 javaee7 simple sample output">
</div>
<div class="title">Figure 20. Java EE 7 Simple Sample Output</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_application_using_management_api">Deploy Application Using Management API</h3>
<div class="paragraph">
<p>A standalone WildFly process, process can be configured to listen for remote management requests using its &#8220;native management interface&#8221;. The CLI tool that comes with the application server uses this interface, and user can develop custom clients that use it as well. By default, WildFly management interface listens on 127.0.0.1. When running inside a Docker container, the network interface should be bound to all publicly assigned addresses. This can be easily changed by biding to 0.0.0.0 instead of 127.0.0.1.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start another WildFly instance again:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run -d --name wildfly -p 8080:8080 -p 9990:9990 arungupta/wildfly-management</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to application port 8080, the administration port 9990 is exposed as well. The WildFly image that is used has tweaked the start script such that the management interface is bound to 0.0.0.0.</p>
</div>
</li>
<li>
<p>Create a new server adapter in JBoss Developer Studio and name it &#8220;WildFly 9.0.0-Management&#8221;. Specify the host name as &#8216;dockerhost&#8217;.</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds8.png" alt="jbds8">
</div>
</div>
</li>
<li>
<p>Click on &#8216;Next&gt;&#8217; and change the values as shown.</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds9.png" alt="jbds9">
</div>
<div class="title">Figure 21. Create New Server Adapter</div>
</div>
</li>
<li>
<p>Take the default values in &#8216;Remote System Integration&#8217; and click on &#8216;Finish&#8217;.</p>
</li>
<li>
<p>Change server properties by double clicking on the newly created server adapter. Specify admin credentials (username: docker, password: docker#admin). Note, you need to delete the existing password and use this instead:</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds10.png" alt="jbds10">
</div>
<div class="title">Figure 22. Management Login Credentials</div>
</div>
</li>
<li>
<p>Right-click on the newly created server adapter and click &#8216;Start&#8217;. Status quickly changes to &#8216;Started&#8217; as shown.</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds11.png" alt="jbds11">
</div>
<div class="title">Figure 23. Synchronized WildFly Server</div>
</div>
</li>
<li>
<p>Right-click on the javaee7-simple-sample project, select &#8216;Run on Server&#8217; and choose this server. The project runs and displays the start page of the application.</p>
</li>
<li>
<p>Stop WildFly when you&#8217;re done.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker stop wildfly</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_docker_maven_plugin">Docker Maven Plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Maven plugin allows you to manage Docker images and containers from <code>pom.xml</code>. It comes with predefined goals:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Goal</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker:start</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create and start containers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker:stop</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stop and destroy containers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker:build</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Build images</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker:push</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Push images to a registry</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker:remove</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove images from local docker host</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker:logs</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Show container logs</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="_run_java_ee_application">Run Java EE Application</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone the workspace as:</p>
<div class="literalblock">
<div class="content">
<pre>git clone https://github.com/javaee-samples/javaee7-docker-maven.git</pre>
</div>
</div>
</li>
<li>
<p>Build the image as:</p>
<div class="literalblock">
<div class="content">
<pre>mvn package -Pdocker</pre>
</div>
</div>
</li>
<li>
<p>Verify the image as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker images
REPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
arungupta/javaee7-docker-maven    latest              2e51b3fca40f        4 seconds ago       581.5 MB</code></pre>
</div>
</div>
</li>
<li>
<p>Run the container as:</p>
<div class="literalblock">
<div class="content">
<pre>mvn install -Pdocker</pre>
</div>
</div>
</li>
<li>
<p>Access your application at <a href="http://dockerhost:8080/javaee7-docker-maven/resources/persons" class="bare">http://dockerhost:8080/javaee7-docker-maven/resources/persons</a>. It shows the output as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">curl http://dockerhost:8080/javaee7-docker-maven/resources/persons
&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;&lt;collection&gt;&lt;person&gt;&lt;name&gt;Penny&lt;/name&gt;&lt;/person&gt;&lt;person&gt;&lt;name&gt;Leonard&lt;/name&gt;&lt;/person&gt;&lt;person&gt;&lt;name&gt;Sheldon&lt;/name&gt;&lt;/person&gt;&lt;person&gt;&lt;name&gt;Amy&lt;/name&gt;&lt;/person&gt;&lt;person&gt;&lt;name&gt;Howard&lt;/name&gt;&lt;/person&gt;&lt;person&gt;&lt;name&gt;Bernadette&lt;/name&gt;&lt;/person&gt;&lt;person&gt;&lt;name&gt;Raj&lt;/name&gt;&lt;/person&gt;&lt;person&gt;&lt;name&gt;Priya&lt;/name&gt;&lt;/person&gt;&lt;/collection&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_understand_plugin_configuration">Understand Plugin Configuration</h3>
<div class="paragraph">
<p><code>pom.xml</code> is updated to include docker-maven-plugin as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;org.jolokia&lt;/groupId&gt;
    &lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;0.11.5&lt;/version&gt;
    &lt;configuration&gt;
        &lt;images&gt;
            &lt;image&gt;
                &lt;alias&gt;user&lt;/alias&gt;
                &lt;name&gt;arungupta/javaee7-docker-maven&lt;/name&gt;
                &lt;build&gt;
                    &lt;from&gt;arungupta/wildfly:8.2&lt;/from&gt;
                    &lt;assembly&gt;
                        &lt;descriptor&gt;assembly.xml&lt;/descriptor&gt;
                        &lt;basedir&gt;/&lt;/basedir&gt;
                    &lt;/assembly&gt;
                    &lt;ports&gt;
                        &lt;port&gt;8080&lt;/port&gt;
                    &lt;/ports&gt;
                &lt;/build&gt;
                &lt;run&gt;
                    &lt;ports&gt;
                        &lt;port&gt;8080:8080&lt;/port&gt;
                    &lt;/ports&gt;
                &lt;/run&gt;
            &lt;/image&gt;
        &lt;/images&gt;
    &lt;/configuration&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;docker:build&lt;/id&gt;
            &lt;phase&gt;package&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;build&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
        &lt;execution&gt;
            &lt;id&gt;docker:start&lt;/id&gt;
            &lt;phase&gt;install&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;start&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each image configuration has three parts:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Image name and alias</p>
</li>
<li>
<p><code>&lt;build&gt;</code> that defines how the image is created. Base image, build artifacts and their dependencies, ports to be exposed, etc to be included in the image are specified here. <a href="http://maven.apache.org/plugins/maven-assembly-plugin/assembly.html">Assembly descriptor format</a> is used to specify the artifacts to be included and is defined in the <code>src/main/docker</code> directory.</p>
<div class="paragraph">
<p><code>assembly.xml</code> in our case looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;assembly . . .&gt;
  &lt;id&gt;javaee7-docker-maven&lt;/id&gt;
  &lt;dependencySets&gt;
    &lt;dependencySet&gt;
      &lt;includes&gt;
        &lt;include&gt;org.javaee7.sample:javaee7-docker-maven&lt;/include&gt;
      &lt;/includes&gt;
      &lt;outputDirectory&gt;/opt/jboss/wildfly/standalone/deployments/&lt;/outputDirectory&gt;
      &lt;outputFileNameMapping&gt;javaee7-docker-maven.war&lt;/outputFileNameMapping&gt;
    &lt;/dependencySet&gt;
  &lt;/dependencySets&gt;
&lt;/assembly&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>&lt;run&gt;</code> that defines how the container is run. Ports that need to be exposed are specified here.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In addition, <code>package</code> phase is tied to <code>docker:build</code> goal and <code>install</code> phase is tied to <code>docker:start</code> goal.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_docker_tools_in_eclipse">Docker Tools in Eclipse</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Docker tooling is aimed at providing at minimum the same basic level features as the command-line interface, but also provide some advantages by having access to a full fledged UI.</p>
</div>
<div class="sect2">
<h3 id="_install_docker_tools_plugins">Install Docker Tools Plugins</h3>
<div class="paragraph">
<p>As this is still in early access stage, you will have to install it first:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use JBoss Developer Studio 9.0 Beta 2.</p>
<div class="paragraph">
<p>Alternatively, download <a href="http://www.eclipse.org/downloads/index-developer-default.php">Eclipse Mars latest build</a> and configure JBoss Tools plugin from the update site <a href="http://download.jboss.org/jbosstools/updates/nightly/mars/" class="bare">http://download.jboss.org/jbosstools/updates/nightly/mars/</a>.</p>
</div>
</li>
<li>
<p>Open JBoss Developer Studio 9.0 Nightly</p>
</li>
<li>
<p>Add a new site using the menu items: &#8216;Help&#8217; &gt; &#8216;Install New Software&#8230;&#8203;&#8217; &gt; &#8216;Add&#8230;&#8203;&#8217;.</p>
<div class="paragraph">
<p>Specify the &#8216;Name:&#8217; as &#8220;Docker Nightly&#8221; and &#8216;Location:&#8217; as <a href="http://download.eclipse.org/linuxtools/updates-docker-nightly/" class="bare">http://download.eclipse.org/linuxtools/updates-docker-nightly/</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools1.png" alt="jbds docker tools1">
</div>
<div class="title">Figure 24. Add Docker Tooling To JBoss Developer Studio</div>
</div>
</li>
<li>
<p>Expand Linux Tools, select &#8216;Docker Client&#8217; and &#8216;Docker Tooling&#8217;.</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools-nightly-setup.png" alt="jbds docker tools nightly setup">
</div>
<div class="title">Figure 25. Add Docker Tooling</div>
</div>
</li>
<li>
<p>Click on &#8216;Next &gt;&#8217;, &#8216;Next &gt;&#8217;, accept the terms of the license agreement, and click on &#8216;Finish&#8217;. This will complete the installation of plugins.</p>
<div class="paragraph">
<p>Restart the IDE for the changes to take effect.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_docker_explorer">Docker Explorer</h3>
<div class="paragraph">
<p>The Docker Explorer provides a wizard to establish a new connection to a Docker daemon. This wizard can detect default settings if the user’s machine runs Docker natively (such as in Linux) or in a VM using Boot2Docker (such as in Mac or Windows). Both Unix sockets on Linux machines and the REST API on other OSes are detected and supported. The wizard also allows remote connections using custom settings.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the menu &#8216;Window&#8217;, &#8216;Show View&#8217;, &#8216;Other&#8230;&#8203;&#8217;. Type &#8216;docker&#8217; to see the output as:</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools-docker-view.png" alt="jbds docker tools docker view">
</div>
</div>
</li>
<li>
<p>Select &#8216;Docker Explorer&#8217; to open Docker Explorer.</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools-docker-explorer-view.png" alt="jbds docker tools docker explorer view">
</div>
</div>
</li>
<li>
<p>Click on the link in this window to create a connection to Docker Host. Specify the settings as shown:</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools2.png" alt="jbds docker tools2">
</div>
<div class="title">Figure 26. Docker Explorer</div>
</div>
<div class="paragraph">
<p>Make sure to get IP address of the Docker Host as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker-machine ip default</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, make sure to specify the correct directory for <code>.docker</code> on your machine.</p>
</div>
</li>
<li>
<p>Click on &#8216;Test Connection&#8217; to check the connection. This should show the output as:</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools-test-connection-output.png" alt="jbds docker tools test connection output">
</div>
<div class="title">Figure 27. Docker Explorer</div>
</div>
<div class="paragraph">
<p>Click on &#8216;OK&#8217; and &#8216;Finish&#8217; to exit out of the wizard.</p>
</div>
</li>
<li>
<p>Docker Explorer itself is a tree view that handles multiple connections and provides users with quick overview of the existing images and containers.</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools3.png" alt="jbds docker tools3">
</div>
<div class="title">Figure 28. Docker Explorer Tree View</div>
</div>
</li>
<li>
<p>Customize the view by clicking on the arrow in toolbar:</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools-customize-view-option.png" alt="jbds docker tools customize view option">
</div>
<div class="title">Figure 29. Docker Explorer Customize View</div>
</div>
<div class="paragraph">
<p>Built-in filters can show/hide intermediate and &#8216;dangling&#8217; images, as well as stopped containers.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools-customize-view-wizard.png" alt="jbds docker tools customize view wizard">
</div>
<div class="title">Figure 30. Docker Explorer Customize View Wizard</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_docker_images">Docker Images</h3>
<div class="paragraph">
<p>The Docker Images view lists all images in the Docker host selected in the Docker Explorer view. This view allows user to manage images, including:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pull/push images from/to the Docker Hub Registry (other registries will be supported as well, <a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=469306">#469306</a>)</p>
</li>
<li>
<p>Build images from a Dockerfile</p>
</li>
<li>
<p>Create a container from an image</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Lets take a look at it.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the menu &#8216;Window&#8217;, &#8216;Show View&#8217;, &#8216;Other&#8230;&#8203;&#8217;, select &#8216;Docker Images&#8217;. It shows the list of images on Docker Host:</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools4.png" alt="jbds docker tools4">
</div>
<div class="title">Figure 31. Docker Images View</div>
</div>
</li>
<li>
<p>Right-click on the image ending with &#8220;wildfly:latest&#8221; and click on the green arrow in the toolbar. This will show the following wizard:</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools-run-container-wizard.png" alt="jbds docker tools run container wizard">
</div>
<div class="title">Figure 32. Docker Run Container Wizard</div>
</div>
<div class="paragraph">
<p>By default, all exports ports from the image are mapped to random ports on the host interface. This setting can be changed by unselecting the first checkbox and specify exact port mapping.</p>
</div>
<div class="paragraph">
<p>Click on &#8216;Finish&#8217; to start the container.</p>
</div>
</li>
<li>
<p>When the container is started, all logs are streamed into Eclipse Console:</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools5.png" alt="jbds docker tools5">
</div>
<div class="title">Figure 33. Docker Container Logs</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_docker_containers">Docker Containers</h3>
<div class="paragraph">
<p>Docker Containers view lets the user manage the containers. The view toolbar provides commands to start, stop, pause, unpause, display the logs and kill containers.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the menu &#8216;Window&#8217;, &#8216;Show View&#8217;, &#8216;Other&#8230;&#8203;&#8217;, select &#8216;Docker Containers&#8217;. It shows the list of running containers on Docker Host:</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools6.png" alt="jbds docker tools6">
</div>
<div class="title">Figure 34. Docker Containers View</div>
</div>
</li>
<li>
<p>Pause the container by clicking on the &#8220;pause&#8221; button in the toolbar (<a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=469310">#469310</a>). Show the complete list of containers by clicking on the &#8216;View Menu&#8217;, &#8216;Show all containers&#8217;.</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools-all-containers.png" alt="jbds docker tools all containers">
</div>
<div class="title">Figure 35. All Docker Containers</div>
</div>
</li>
<li>
<p>Select the paused container, and click on the green arrow in the toolbar to restart the container.</p>
</li>
<li>
<p>Right-click on any running container and select &#8220;Display Log&#8221; to view the log for this container.</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools-display-log.png" alt="jbds docker tools display log">
</div>
<div class="title">Figure 36. Eclipse Properties View</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>TODO: Users can also attach an Eclipse console to a running Docker container to follow the logs and use the STDIN to interact with it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_details_on_images_and_containers">Details on Images and Containers</h3>
<div class="paragraph">
<p>Eclipse Properties view is used to provide more information about the containers and images.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Just open the Properties View and click on a Connection, Container, or Image in any of the Docker Explorer View, Docker Containers View, or Docker Images View. This will fill in data in the Properties view.</p>
<div class="paragraph">
<p>Info view is shown as:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools-properties-info.png" alt="jbds docker tools properties info">
</div>
<div class="title">Figure 37. Docker Container Properties View Info</div>
</div>
<div class="paragraph">
<p>Inspect view is shown as:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/jbds-docker-tools-properties-inspect.png" alt="jbds docker tools properties inspect">
</div>
<div class="title">Figure 38. Docker Container Properties View Inspect</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_java_ee_applications_on_docker">Test Java EE Applications on Docker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Testing Java EE applications is a very important aspect. Especially when it comes to in-container tests, <a href="http://www.arquillian.org">JBoss Arquillian</a> is well known to make this very easy for Java EE application servers. Picking up where unit tests leave off, Arquillian handles all the plumbing of container management, deployment and framework initialization so you can focus on the task at hand, writing your tests.</p>
</div>
<div class="paragraph">
<p>With Arquillian, you can use <a href="http://arquillian.org/modules/wildfly-arquillian-wildfly-remote-container-adapter/">WildFly remote container adapter</a> and connect to any WildFly instance running in a Docker container. But this wouldn&#8217;t help with the Docker container lifycycle management.</p>
</div>
<div class="paragraph">
<p><a href="http://arquillian.org/modules/cube-extension/">Arquillian Cube</a>, an extension of Arquillian, allows you to control the lifecycle of Docker images as part of the test lifecyle, either automatically or manually. This extension allows to start a Docker container with a server installed, deploy the required deployable file within it and execute Arquillian tests.</p>
</div>
<div class="paragraph">
<p>The key point here is that if Docker is used as deployable platform in production, your tests are executed in a the same container as it will be in production, so your tests are even more real than before.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check out the workspace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">git clone http://github.com/javaee-samples/javaee-arquillian-cube</code></pre>
</div>
</div>
</li>
<li>
<p>Edit <code>src/test/resources/arquillian.xml</code> file and change the IP address specified in <code>serverUri</code> property value to point to your Docker host&#8217;s IP. This can be found out as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker-machine ip lab</code></pre>
</div>
</div>
</li>
<li>
<p>Run the tests as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">mvn test</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will create a container using the image defined in <code>src/test/resources/wildfly/Dockerfile</code>. The container qualifier in <code>arquillian.xml</code> defines the directory name in <code>src/test/resources</code> directory.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>A pre-built image can be used by specifying:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wildfly:
  image: jboss/wildfly</pre>
</div>
</div>
<div class="paragraph">
<p>instead of</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wildfly:
  buildImage:
    dockerfileLocation: src/test/resources/wildfly</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, the &#8220;cube&#8221; profile is activated and this includes all the required dependencies.</p>
</div>
<div class="paragraph">
<p>The result is shown as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">Running org.javaee7.sample.PersonDatabaseTest
Jun 16, 2015 9:23:04 AM org.jboss.arquillian.container.impl.MapObject populate
WARNING: Configuration contain properties not supported by the backing object org.jboss.as.arquillian.container.remote.RemoteContainerConfiguration
Unused property entries: {target=wildfly:8.1.0.Final:remote}
Supported property names: [managementAddress, password, managementPort, managementProtocol, username]
Jun 16, 2015 9:23:13 AM org.xnio.Xnio &lt;clinit&gt;
INFO: XNIO version 3.2.0.Beta4
Jun 16, 2015 9:23:13 AM org.xnio.nio.NioXnio &lt;clinit&gt;
INFO: XNIO NIO Implementation Version 3.2.0.Beta4
Jun 16, 2015 9:23:13 AM org.jboss.remoting3.EndpointImpl &lt;clinit&gt;
INFO: JBoss Remoting version (unknown)
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 16.406 sec - in org.javaee7.sample.PersonDatabaseTest

Results :

Tests run: 1, Failures: 0, Errors: 0, Skipped: 0

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
</li>
<li>
<p>In <code>arquillian.xml</code>, add the following property:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;property name="connectionMode"&gt;STARTORCONNECT&lt;/property&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This bypasses the create/start Cube commands if a Docker Container with the same name is already running on the target system.</p>
</div>
<div class="paragraph">
<p>This allows you to prestart the containers manually during development and just connect to them to avoid the extra cost of starting the Docker Containers for each test run. This assumes you are not changing the actual definition of the Docker Container itself.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Docker_Compose">Multiple Containers Using Docker Compose</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Docker Compose is a tool for defining and running complex applications with Docker. With Compose, you define a multi-container application in a single file, then spin your application up in a single command which does everything that needs to be done to get it running.
</blockquote>
<div class="attribution">
&#8212; github.com/docker/compose
</div>
</div>
<div class="paragraph">
<p>An application using Docker containers will typically consist of multiple containers. With Docker Compose, there is no need to write shell scripts to start your containers. All the containers are defined in a configuration file using <em>services</em>, and then <code>docker-compose</code> script is used to start, stop, and restart the application and all the services in that application, and all the containers within that service. The complete list of commands is:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Command</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>build</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Build or rebuild services</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>help</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get help on a command</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kill</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kill containers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logs</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">View output from containers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Print the public port for a port binding</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ps</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List containers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pulls service images</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>restart</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Restart services</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove stopped containers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>run</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run a one-off command</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scale</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set number of containers for a service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>start</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start services</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stop</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stop services</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>up</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create and start containers</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Docker Compose applications can use &#8220;classic&#8221; container linking that is confined to a single host. Alternatively, it can use multi-host networking introduced in Docker 1.9.</p>
</div>
<div class="sect2">
<h3 id="_single_host_container_linking">Single Host Container Linking</h3>
<div class="sect3">
<h4 id="_configuration_file">Configuration File</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Entry point to Compose is <code>docker-compose.yml</code>. Lets use the following file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">mysqldb:
  image: mysql
  environment:
    MYSQL_DATABASE: sample
    MYSQL_USER: mysql
    MYSQL_PASSWORD: mysql
    MYSQL_ROOT_PASSWORD: supersecret
mywildfly:
  image: arungupta/wildfly-mysql-javaee7
  links:
    - mysqldb:db
  ports:
    - 8080:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>This file is available in <a href="https://github.com/javaee-samples/docker-java/raw/master/attendees/docker-compose.yml" class="bare">https://github.com/javaee-samples/docker-java/raw/master/attendees/docker-compose.yml</a> and shows:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Two services defined by the name <code>mysqldb</code> and <code>mywildfly</code></p>
</li>
<li>
<p>Image name for each service defined using <code>image</code></p>
</li>
<li>
<p>Environment variables for the MySQL container are defined in <code>environment</code></p>
</li>
<li>
<p>MySQL container is linked with WildFly container using <code>links</code></p>
</li>
<li>
<p>Port forwarding is achieved using <code>ports</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_start_services">Start Services</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>All services can be started, in detached mode, by giving the command:</p>
<div class="literalblock">
<div class="content">
<pre>docker-compose up -d</pre>
</div>
</div>
<div class="paragraph">
<p>And this shows the output as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Creating attendees_mysqldb_1...
Creating attendees_mywildfly_1...</pre>
</div>
</div>
<div class="paragraph">
<p>An alternate compose file name can be specified using <code>-f</code>.</p>
</div>
<div class="paragraph">
<p>An alternate directory where the compose file exists can be specified using <code>-p</code>.</p>
</div>
</li>
<li>
<p>Started services can be verified as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&gt; docker-compose ps
        Name                       Command               State                Ports
-------------------------------------------------------------------------------------------------
attendees_mysqldb_1     /entrypoint.sh mysqld            Up      3306/tcp
attendees_mywildfly_1   /opt/jboss/wildfly/customi ...   Up      0.0.0.0:8080-&gt;8080/tcp, 9990/tcp</code></pre>
</div>
</div>
<div class="paragraph">
<p>This provides a consolidated view of all the services started, and containers within them.</p>
</div>
<div class="paragraph">
<p>Alternatively, the containers in this application, and any additional containers running on this Docker host can be verified by using the usual <code>docker ps</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&gt; docker ps
CONTAINER ID        IMAGE                                    COMMAND                CREATED             STATUS              PORTS                              NAMES
3598e545bd2f        arungupta/wildfly-mysql-javaee7:latest   "/opt/jboss/wildfly/   59 seconds ago      Up 58 seconds       0.0.0.0:8080-&gt;8080/tcp, 9990/tcp   attendees_mywildfly_1
b8cf6a3d518b        mysql:latest                             "/entrypoint.sh mysq   2 minutes ago       Up 2 minutes        3306/tcp                           attendees_mysqldb_1</code></pre>
</div>
</div>
</li>
<li>
<p>Service logs can be seen as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&gt; docker-compose logs
Attaching to attendees_mywildfly_1, attendees_mysqldb_1
mywildfly_1 | =&gt; Starting WildFly server
mywildfly_1 | =&gt; Waiting for the server to boot
mywildfly_1 | =========================================================================
mywildfly_1 |
mywildfly_1 |   JBoss Bootstrap Environment
mywildfly_1 |
mywildfly_1 |   JBOSS_HOME: /opt/jboss/wildfly
mywildfly_1 |
mywildfly_1 |   JAVA: /usr/lib/jvm/java/bin/java
mywildfly_1 |
mywildfly_1 |   JAVA_OPTS:  -server -Xms64m -Xmx512m -XX:MaxPermSize=256m -Djava.net.preferIPv4Stack=true -Djboss.modules.system.pkgs=org.jboss.byteman -Djava.awt.headless=true
mywildfly_1 |

. . .

mywildfly_1 | 15:40:20,866 INFO  [org.jboss.resteasy.spi.ResteasyDeployment] (MSC service thread 1-2) Deploying javax.ws.rs.core.Application: class org.javaee7.samples.employees.MyApplication
mywildfly_1 | 15:40:20,914 INFO  [org.wildfly.extension.undertow] (MSC service thread 1-2) JBAS017534: Registered web context: /employees
mywildfly_1 | 15:40:21,032 INFO  [org.jboss.as.server] (ServerService Thread Pool -- 28) JBAS018559: Deployed "employees.war" (runtime-name : "employees.war")
mywildfly_1 | 15:40:21,077 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015961: Http management interface listening on http://127.0.0.1:9990/management
mywildfly_1 | 15:40:21,077 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015951: Admin console listening on http://127.0.0.1:9990
mywildfly_1 | 15:40:21,077 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015874: WildFly 8.2.0.Final "Tweek" started in 9572ms - Started 280 of 334 services (92 services are lazy, passive or on-demand)
mysqldb_1   | Running mysql_install_db
mysqldb_1   | 2015-06-05 15:38:31 0 [Note] /usr/sbin/mysqld (mysqld 5.6.25) starting as process 27 ...
mysqldb_1   | 2015-06-05 15:38:31 27 [Note] InnoDB: Using atomics to ref count buffer pool pages

. . .

mysqldb_1   | 2015-06-05 15:38:40 1 [Note] Event Scheduler: Loaded 0 events
mysqldb_1   | 2015-06-05 15:38:40 1 [Note] mysqld: ready for connections.
mysqldb_1   | Version: '5.6.25'  socket: '/var/run/mysqld/mysqld.sock'  port: 3306  MySQL Community Server (GPL)
mysqldb_1   | 2015-06-05 15:40:18 1 [Warning] IP address '172.17.0.24' could not be resolved: Name or service not known</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_verify_application">Verify Application</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Access the application at <a href="http://dockerhost:8080/employees/resources/employees/" class="bare">http://dockerhost:8080/employees/resources/employees/</a>. This is shown in the browser as:</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/docker-compose-output.png" alt="docker compose output">
</div>
<div class="title">Figure 39. Output From Servers Run Using Docker Compose</div>
</div>
</div>
<div class="sect3">
<h4 id="_stop_services">Stop Services</h4>
<div class="paragraph">
<p>Stop the services as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker-compose stop
Stopping attendees_mywildfly_1...
Stopping attendees_mysqldb_1...</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Stopping and starting the containers again will give the following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">wildfly_1 |
wildfly_1 | 09:11:07,802 ERROR [org.jboss.as.controller.management-operation] (management-handler-thread - 4) JBAS014613: Operation ("add") failed - address: ([
wildfly_1 |     ("subsystem" =&gt; "datasources"),
wildfly_1 |     ("jdbc-driver" =&gt; "mysql")
wildfly_1 | ]) - failure description: "JBAS014803: Duplicate resource [
wildfly_1 |     (\"subsystem\" =&gt; \"datasources\"),
wildfly_1 |     (\"jdbc-driver\" =&gt; \"mysql\")
wildfly_1 | ]"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is expected because the JDBC resource is created during every run of the container. In a real-world application, this would be pre-baked in the configuration already.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_remove_containers">Remove Containers</h4>
<div class="paragraph">
<p>Stop the services as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker-compose rm -f
Going to remove attendees_mywildfly_1, attendees_mysqldb_1
Removing attendees_mywildfly_1... done
Removing attendees_mysqldb_1... done</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_scale_services">Scale Services</h4>
<div class="paragraph">
<p><a href="https://github.com/arun-gupta/docker-java/issues/51" class="bare">https://github.com/arun-gupta/docker-java/issues/51</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multi_host_networking">Multi-host Networking</h3>
<div class="paragraph">
<p>Start a Java EE application with WildFly and MySQL containers.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new directory and name it <code>wildfly-mysql-javaee7</code>.</p>
</li>
<li>
<p>Create a new file <code>docker-compose.yml</code> and copy the contents from the following:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">mysqldb:
  container_name: "db"
  image: mysql:latest
  environment:
    MYSQL_DATABASE: sample
    MYSQL_USER: mysql
    MYSQL_PASSWORD: mysql
    MYSQL_ROOT_PASSWORD: supersecret
mywildfly:
  image: arungupta/wildfly-mysql-javaee7
  environment:
    - MYSQL_URI=db:3306
  ports:
    - 8080:8080</code></pre>
</div>
</div>
</li>
<li>
<p>Run the application as:</p>
<div class="paragraph">
<p><code>docker-compose --x-networking up -d</code></p>
</div>
<div class="paragraph">
<p><code>--x-networking</code> will create a bridge network. Docker 1.9 is required to run this application.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Docker_Swarm">Deploy Application on Docker Swarm Cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Docker Swarm is native clustering for Docker. It allows you to create and access a pool of Docker hosts using the full suite of Docker tools. Because Docker Swarm serves the standard Docker API, any tool that already communicates with a Docker daemon can use Swarm to transparently scale to multiple hosts.</p>
</div>
<div class="sect2">
<h3 id="_key_components_of_docker_swarm">Key Components of Docker Swarm</h3>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/docker-swarm-components.png" alt="docker swarm components">
</div>
<div class="title">Figure 40. Key Components of Docker Swarm</div>
</div>
<div class="paragraph">
<p><strong>Swarm Manager</strong>: Docker Swarm has a Manager that is a pre-defined Docker Host and is a single point for all administration. Swarm manager orchestrates and schedules containers in the entire cluster. Swarm Manager can be configured to enable <a href="https://docs.docker.com/swarm/multi-manager-setup/">High Availability</a>.</p>
</div>
<div class="paragraph">
<p><strong>Swarm Nodes</strong>: The containers are deployed on Nodes that are additional Docker Hosts. Each Swarm Node must be accessible by the manager, each node must listen to the same network interface (TCP port). Each node runs a Docker Swarm agent that registers the referenced Docker daemon, monitors it, and updates the discovery backend with the node’s status. The containers run on a node.</p>
</div>
<div class="paragraph">
<p><strong>Scheduler Strategy</strong>: Different scheduler strategies (&#8220;binpack&#8221;, &#8220;spread&#8221; (default), and &#8220;random&#8221;) can be applied to pick the best node to run your container. The default strategy optimizes the node for least number of running containers. There are multiple kinds of filters, such as constraints and affinity.  This should allow for a decent scheduling algorithm.</p>
</div>
<div class="paragraph">
<p><strong>Node Discovery Service</strong>: Swarm manager talks to a hosted discovery service. This service maintains a list of IPs in the Swarm cluster. Docker Hub hosts a discovery service that can be used during development. In production, this is replaced by other services such as <code>etcd</code>, <code>consul</code>, or <code>zookeeper</code>. You can even use a static file. This is particularly useful if there is no Internet access or you are running in a closed network.</p>
</div>
<div class="paragraph">
<p><strong>Standard Docker API</strong>: Docker Swarm serves the standard Docker API and thus any tool that talks to a single Docker host will seamlessly scale to multiple hosts now. That means that if you were using shell scripts using Docker CLI to configure multiple Docker hosts, the same CLI could now talk to the Swarm cluster.</p>
</div>
<div class="paragraph">
<p>There are a lots of other concepts but these are the main ones.</p>
</div>
<div class="paragraph">
<p>This section will deploy an application that will provide a CRUD/REST interface on a data bucket in Couchbase. This is achieved by using a Java EE application deployed on WildFly to access the database.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create_discovery_service">Create Discovery Service</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a Machine that will host discovery service:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker-machine create -d=virtualbox consul-machine
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
To see how to connect Docker to this machine, run: docker-machine env consul-machine</code></pre>
</div>
</div>
</li>
<li>
<p>Connect to this Machine:</p>
<div class="literalblock">
<div class="content">
<pre>eval $(docker-machine env consul-machine)</pre>
</div>
</div>
</li>
<li>
<p>Run Consul service using the following Compose file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">myconsul:
  image: progrium/consul
  restart: always
  hostname: consul
  ports:
    - 8500:8500
  command: "-server -bootstrap"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This Compose file is available at <a href="https://github.com/arun-gupta/docker-images/blob/master/consul/docker-compose.yml" class="bare">https://github.com/arun-gupta/docker-images/blob/master/consul/docker-compose.yml</a>.</p>
</div>
<div class="paragraph">
<p>Start this service as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker-compose up -d
Pulling myconsul (progrium/consul:latest)...
latest: Pulling from progrium/consul
3b4d28ce80e4: Pull complete
e5ab901dcf2d: Pull complete
30ad296c0ea0: Pull complete
3dba40dec256: Pull complete
f2ef4387b95e: Pull complete
53bc8dcc4791: Pull complete
75ed0b50ba1d: Pull complete
17c3a7ed5521: Pull complete
8aca9e0ecf68: Pull complete
4d1828359d36: Pull complete
46ed7df7f742: Pull complete
b5e8ce623ef8: Pull complete
049dca6ef253: Pull complete
bdb608bc4555: Pull complete
8b3d489cfb73: Pull complete
c74500bbce24: Pull complete
9f3e605442f6: Pull complete
d9125e9e799b: Pull complete
Digest: sha256:8cc8023462905929df9a79ff67ee435a36848ce7a10f18d6d0faba9306b97274
Status: Downloaded newer image for progrium/consul:latest
Creating consul_myconsul_1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Started container can be verified as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                                                            NAMES
f05d8dd11e7f        progrium/consul     "/bin/start -server -"   30 seconds ago      Up 29 seconds       53/tcp, 53/udp, 8300-8302/tcp, 8400/tcp, 0.0.0.0:8500-&gt;8500/tcp, 8301-8302/udp   consul_myconsul_1</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_create_docker_swarm_cluster">Create Docker Swarm Cluster</h3>
<div class="paragraph">
<p>Swarm is fully integrated with Machine, and so is the easiest way to get started.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a Swarm Master and point to the Consul discovery service:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker-machine create -d virtualbox --virtualbox-disk-size "5000" --swarm --swarm-master --swarm-discovery="consul://$(docker-machine ip consul-machine):8500" --engine-opt="cluster-store=consul://$(docker-machine ip consul-machine):8500" --engine-opt="cluster-advertise=eth1:2376" swarm-master
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Configuring swarm...
To see how to connect Docker to this machine, run: docker-machine env swarm-master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Few options to look here:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>--swarm</code> configures the Machine with Swarm</p>
</li>
<li>
<p><code>--swarm-master</code> configures the created Machine to be Swarm master</p>
</li>
<li>
<p><code>--swarm-discovery</code> defines address of the discovery service</p>
</li>
<li>
<p><code>--cluster-advertise</code> advertise the machine on the network</p>
</li>
<li>
<p><code>--cluster-store</code> designate a distributed k/v storage backend for the cluster</p>
</li>
<li>
<p><code>--virtualbox-disk-size</code> sets the disk size for the created Machine to 5GB. This is required so that WildFly and Couchbase image can be downloaded on any of the nodes.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Find some information about this machine:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">docker-machine inspect --format='{{json .Driver}}'  swarm-master
{"Boot2DockerImportVM":"","Boot2DockerURL":"","CPU":1,"DiskSize":5000,"HostOnlyCIDR":"192.168.99.1/24","HostOnlyNicType":"82540EM","HostOnlyPromiscMode":"deny","IPAddress":"192.168.99.102","MachineName":"swarm-master","Memory":1024,"NoShare":false,"SSHPort":51972,"SSHUser":"docker","StorePath":"/Users/arungupta/.docker/machine","SwarmDiscovery":"consul://192.168.99.100:8500","SwarmHost":"tcp://0.0.0.0:3376","SwarmMaster":true,"VBoxManager":{}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the disk size is 5GB.</p>
</div>
</li>
<li>
<p>Connect to the Swarm cluster by using the command:</p>
<div class="literalblock">
<div class="content">
<pre>eval "$(docker-machine env --swarm swarm-master)"</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>--swarm</code> is specified to connect to the Swarm cluster. Otherwise the command will connect to <code>swarm-master</code> Machine only. However, if you&#8217;re on Windows, then use the <code>docker-machine env swarm-master</code> command only. Then copy the output into an editor to replace all appearances of EXPORT with SET, remove the quotes, and all appearances of "/" with "\". Finally, issue the three commands at your command prompt.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Get information about the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker info
Containers: 2
Images: 1
Role: primary
Strategy: spread
Filters: health, port, dependency, affinity, constraint
Nodes: 1
 swarm-master: 192.168.99.102:2376
  └ Containers: 2
  └ Reserved CPUs: 0 / 1
  └ Reserved Memory: 0 B / 1.021 GiB
  └ Labels: executiondriver=native-0.2, kernelversion=4.1.13-boot2docker, operatingsystem=Boot2Docker 1.9.1 (TCL 6.4.1); master : cef800b - Fri Nov 20 19:33:59 UTC 2015, provider=virtualbox, storagedriver=aufs
CPUs: 1
Total Memory: 1.021 GiB
Name: d074fd97682e</code></pre>
</div>
</div>
<div class="paragraph">
<p>This cluster has one node and that node has two containers.</p>
</div>
</li>
<li>
<p>Create the first Swarm node to join this cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker-machine create -d virtualbox --virtualbox-disk-size "5000" --swarm --swarm-discovery="consul://$(docker-machine ip consul-machine):8500" --engine-opt="cluster-store=consul://$(docker-machine ip consul-machine):8500" --engine-opt="cluster-advertise=eth1:2376" swarm-node-01
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Configuring swarm...
To see how to connect Docker to this machine, run: docker-machine env swarm-node-01</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice no <code>--swarm-master</code> is specified in this command. This ensure that the created Machines are <em>worker</em> nodes.</p>
</div>
</li>
<li>
<p>Create a second Swarm node to join this cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker-machine create -d virtualbox --virtualbox-disk-size "5000" --swarm --swarm-discovery="consul://$(docker-machine ip consul-machine):8500" --engine-opt="cluster-store=consul://$(docker-machine ip consul-machine):8500" --engine-opt="cluster-advertise=eth1:2376" swarm-node-02
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Configuring swarm...
To see how to connect Docker to this machine, run: docker-machine env swarm-node-02</code></pre>
</div>
</div>
</li>
<li>
<p>List all the created Machines:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker-machine ls
NAME             ACTIVE   DRIVER       STATE     URL                         SWARM
consul-machine   -        virtualbox   Running   tcp://192.168.99.100:2376
swarm-master     *        virtualbox   Running   tcp://192.168.99.101:2376   swarm-master (master)
swarm-node-01    -        virtualbox   Running   tcp://192.168.99.102:2376   swarm-master
swarm-node-02    -        virtualbox   Running   tcp://192.168.99.103:2376   swarm-master</code></pre>
</div>
</div>
<div class="paragraph">
<p>The machines that are part of the cluster have cluster’s name in the SWARM column. If the SWARM column is blank, then it is a standalone machine. For example, <code>consul-machine</code> is a standalone machine as opposed to all other machines which are part of the <code>swarm-master</code> cluster. The Swarm master is identified by (master) in the SWARM column.</p>
</div>
</li>
<li>
<p>Get information about the cluster again:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker info
Containers: 4
Images: 3
Role: primary
Strategy: spread
Filters: health, port, dependency, affinity, constraint
Nodes: 3
 swarm-master: 192.168.99.102:2376
  └ Containers: 2
  └ Reserved CPUs: 0 / 1
  └ Reserved Memory: 0 B / 1.021 GiB
  └ Labels: executiondriver=native-0.2, kernelversion=4.1.13-boot2docker, operatingsystem=Boot2Docker 1.9.1 (TCL 6.4.1); master : cef800b - Fri Nov 20 19:33:59 UTC 2015, provider=virtualbox, storagedriver=aufs
 swarm-node-01: 192.168.99.103:2376
  └ Containers: 1
  └ Reserved CPUs: 0 / 1
  └ Reserved Memory: 0 B / 1.021 GiB
  └ Labels: executiondriver=native-0.2, kernelversion=4.1.13-boot2docker, operatingsystem=Boot2Docker 1.9.1 (TCL 6.4.1); master : cef800b - Fri Nov 20 19:33:59 UTC 2015, provider=virtualbox, storagedriver=aufs
 swarm-node-02: 192.168.99.104:2376
  └ Containers: 1
  └ Reserved CPUs: 0 / 1
  └ Reserved Memory: 0 B / 1.021 GiB
  └ Labels: executiondriver=native-0.2, kernelversion=4.1.13-boot2docker, operatingsystem=Boot2Docker 1.9.1 (TCL 6.4.1); master : cef800b - Fri Nov 20 19:33:59 UTC 2015, provider=virtualbox, storagedriver=aufs
CPUs: 3
Total Memory: 3.064 GiB
Name: d074fd97682e</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now there are 3 nodes – one Swarm master and 2 Swarm <em>worker</em> nodes. There are a total of 4 containers running in this cluster – a swarm-agent on each node and an additional swarm-agent-master running on the master. This can be verified by connecting to the master Machine (without specifying <code>--swarm</code>) and listing all the containers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">eval "$(docker-machine env swarm-master)"
docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                              NAMES
cf5edbf4ada7        swarm:latest        "/swarm join --advert"   49 seconds ago      Up 49 seconds       2375/tcp                           swarm-agent
c7c3b80bceb4        swarm:latest        "/swarm manage --tlsv"   49 seconds ago      Up 49 seconds       2375/tcp, 0.0.0.0:3376-&gt;3376/tcp   swarm-agent-master</code></pre>
</div>
</div>
</li>
<li>
<p>You can also query the Consul discovery service while connected to the Swarm cluster, master, or any worker node in the cluster to list the nodes in the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker run swarm list consul://$(docker-machine ip consul-machine):8500
192.168.99.102:2376
192.168.99.103:2376
192.168.99.104:2376</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_start_application_environment_using_docker_compose">Start Application Environment Using Docker Compose</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Connect to the Swarm cluster:</p>
<div class="literalblock">
<div class="content">
<pre>eval "$(docker-machine env --swarm swarm-master)"</pre>
</div>
</div>
</li>
<li>
<p>List all the networks created by Docker so far:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker network ls
NETWORK ID          NAME                   DRIVER
33a619ddc5d2        swarm-node-02/bridge   bridge
e0b73c96ffec        swarm-node-02/none     null
b315e67f0363        swarm-node-02/host     host
879d6167be47        swarm-master/bridge    bridge
f771ddc7d957        swarm-node-01/none     null
e042754df336        swarm-node-01/host     host
d2f3b512f9dc        swarm-node-01/bridge   bridge
5b5bcf135d7b        swarm-master/none      null
fffc34eae907        swarm-master/host      host</code></pre>
</div>
</div>
<div class="paragraph">
<p>Docker creates three networks for each host automatically:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Network Name</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bridge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default network that containers connect to. This is <code>docker0</code> network in all Docker installations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Container-specific networking stack</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>host</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adds a container on hosts networking stack. Network configuration is identical to the host.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A total of nine networks are created for this three-node Swarm cluster because three networks are created for each node.</p>
</div>
</li>
<li>
<p>Use Compose file to start WildFly and Couchbase:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">mycouchbase:
  container_name: "db"
  image: couchbase/server
  ports:
    - 8091:8091
    - 8092:8092
    - 8093:8093
    - 11210:11210
mywildfly:
  image: arungupta/wildfly-admin
  environment:
    - COUCHBASE_URI=db
  ports:
    - 8080:8080
    - 9990:9990</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this Compose file:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Couchbase service has a custom container name defined by <code>container_name</code>. This name is used when creating a new environment variable <code>COUCHBASE_URI</code> during WildFly startup.</p>
</li>
<li>
<p><code>arungupta/wildfly-admin</code> image is used as it binds WildFly’s management to all network interfaces, and in addition also exposes port 9990. This enables WildFly Maven Plugin to be used to deploy the application.</p>
<div class="paragraph">
<p>Source for this file is at <a href="https://github.com/arun-gupta/docker-images/blob/master/wildfly-couchbase-javaee7/docker-compose.yml" class="bare">https://github.com/arun-gupta/docker-images/blob/master/wildfly-couchbase-javaee7/docker-compose.yml</a>.</p>
</div>
<div class="paragraph">
<p>This application environment can be started as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker-compose --x-networking up -d
Creating network "wildflycouchbasejavaee7" with driver "None"
Pulling mywildfly (arungupta/wildfly-admin:latest)...
swarm-node-02: Pulling arungupta/wildfly-admin:latest... : downloaded
swarm-master: Pulling arungupta/wildfly-admin:latest... : downloaded
swarm-node-01: Pulling arungupta/wildfly-admin:latest... : downloaded
Creating wildflycouchbasejavaee7_mywildfly_1
Pulling mycouchbase (couchbase/server:latest)...
swarm-node-02: Pulling couchbase/server:latest... : downloaded
swarm-master: Pulling couchbase/server:latest... : downloaded
swarm-node-01: Pulling couchbase/server:latest... : downloaded
Creating db</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>--x-networking</code> creates an overlay network for the Swarm cluster. This can be verified by listing networks again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker network ls
NETWORK ID          NAME                            DRIVER
5e93fc34b4d9        swarm-node-01/docker_gwbridge   bridge
1c041242f51d        wildflycouchbasejavaee7         overlay
cc8697c6ce13        swarm-master/docker_gwbridge    bridge
f771ddc7d957        swarm-node-01/none              null
879d6167be47        swarm-master/bridge             bridge
5b5bcf135d7b        swarm-master/none               null
fffc34eae907        swarm-master/host               host
e042754df336        swarm-node-01/host              host
d2f3b512f9dc        swarm-node-01/bridge            bridge
33a619ddc5d2        swarm-node-02/bridge            bridge
e0b73c96ffec        swarm-node-02/none              null
b315e67f0363        swarm-node-02/host              host</code></pre>
</div>
</div>
<div class="paragraph">
<p>Three new networks are created:</p>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Containers connected to the multi-host network are automatically connected to the <code>docker_gwbridge</code> network. This network allows the containers to have external connectivity outside of their cluster, and is created on each worker node.</p>
</li>
<li>
<p>A new overlay network <code>wildflycouchbasejavaee7</code> is created. Connect to different Swarm nodes and check that the overlay network exists on them.</p>
<div class="paragraph">
<p>Lets begin with master:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">eval "$(docker-machine env swarm-master)"
docker network ls
NETWORK ID          NAME                      DRIVER
1c041242f51d        wildflycouchbasejavaee7   overlay
879d6167be47        bridge                    bridge
5b5bcf135d7b        none                      null
fffc34eae907        host                      host
cc8697c6ce13        docker_gwbridge           bridge</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, with <code>swarm-node-01</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">eval "$(docker-machine env swarm-node-01)"
docker network ls
NETWORK ID          NAME                      DRIVER
1c041242f51d        wildflycouchbasejavaee7   overlay
d2f3b512f9dc        bridge                    bridge
f771ddc7d957        none                      null
e042754df336        host                      host
5e93fc34b4d9        docker_gwbridge           bridge</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, with <code>swarm-node-02</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">eval "$(docker-machine env swarm-node-02)"
docker network ls
NETWORK ID          NAME                      DRIVER
1c041242f51d        wildflycouchbasejavaee7   overlay
e0b73c96ffec        none                      null
b315e67f0363        host                      host
33a619ddc5d2        bridge                    bridge</code></pre>
</div>
</div>
<div class="paragraph">
<p>As seen, <code>wildflycouchbasejavaee7</code> overlay network exists on all Machines. This confirms that the overlay network created for Swarm cluster was added to each host in the cluster. <code>docker_gwbridge</code> only exists on Machines that have application containers running.</p>
</div>
<div class="paragraph">
<p>Read more about <a href="https://docs.docker.com/engine/userguide/networking/dockernetworks/">Docker Networks</a>.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Connect to the Swarm cluster and verify that WildFly and Couchbase are running:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">eval "$(docker-machine env --swarm swarm-master)"
docker ps
CONTAINER ID        IMAGE                     COMMAND                  CREATED             STATUS              PORTS                                                                                                             NAMES
23a581295a2b        couchbase/server          "/entrypoint.sh couch"   9 seconds ago       Up 8 seconds        192.168.99.102:8091-8093-&gt;8091-8093/tcp, 11207/tcp, 11211/tcp, 192.168.99.102:11210-&gt;11210/tcp, 18091-18092/tcp   swarm-master/db
7a8a885b23f3        arungupta/wildfly-admin   "/opt/jboss/wildfly/b"   9 seconds ago       Up 8 seconds        192.168.99.103:8080-&gt;8080/tcp, 192.168.99.103:9990-&gt;9990/tcp                                                      swarm-node-01/wildflycouchbasejavaee7_mywildfly_1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that, in this example, the Couchbase server is running on <code>swarm-master</code> node and WildFly is running on <code>swarm-node-01</code>. Take a note on which nodes your Couchbase and WildFly servers are running and update the following commands accordingly.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configure_couchbase_server">Configure Couchbase server</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone <a href="https://github.com/arun-gupta/couchbase-javaee.git" class="bare">https://github.com/arun-gupta/couchbase-javaee.git</a>. This workspace contains a simple Java EE application that is deployed on WildFly and provides a REST API over <code>travel-sample</code> bucket in Couchbase.</p>
</li>
<li>
<p>Couchbase server can be configured using <a href="http://developer.couchbase.com/documentation/server/4.0/rest-api/rest-endpoints-all.html">REST API</a>. The application contains a Maven profile that allows to configure the Couchbase server with <code>travel-sample</code> bucket. This can be invoked as: (Note that you may need to replace <code>swarm-master</code> with the node in your cluster that is running Couchbase)</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">mvn install -Pcouchbase -Ddocker.host=$(docker-machine ip swarm-master)

. . .

* Server auth using Basic with user 'Administrator'
&gt; POST /sampleBuckets/install HTTP/1.1
&gt; Authorization: Basic QWRtaW5pc3RyYXRvcjpwYXNzd29yZA==

. . .

} [data not shown]
* upload completely sent off: 17 out of 17 bytes
&lt; HTTP/1.1 202 Accepted
* Server Couchbase Server is not blacklisted
&lt; Server: Couchbase Server

. . .</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_application">Deploy Application</h3>
<div class="paragraph">
<p>Deploy the application to WildFly by specifying three parameters:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Host IP address where WildFly is running (swarm-node-01 in this example but update as needed for your cluster)</p>
</li>
<li>
<p>Username of a user in WildFly&#8217;s administrative realm</p>
</li>
<li>
<p>Password of the user specified in WildFly&#8217;s administrative realm</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">mvn install -Pwildfly -Dwildfly.hostname=$(docker-machine ip swarm-node-01) -Dwildfly.username=admin -Dwildfly.password=Admin#007

. . .

Nov 29, 2015 12:11:14 AM org.xnio.Xnio &lt;clinit&gt;
INFO: XNIO version 3.3.1.Final
Nov 29, 2015 12:11:14 AM org.xnio.nio.NioXnio &lt;clinit&gt;
INFO: XNIO NIO Implementation Version 3.3.1.Final
Nov 29, 2015 12:11:15 AM org.jboss.remoting3.EndpointImpl &lt;clinit&gt;
INFO: JBoss Remoting version 4.0.9.Final
[INFO] Authenticating against security realm: ManagementRealm
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------

. . .</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_access_application">Access Application</h3>
<div class="paragraph">
<p>Now that the WildFly and Couchbase servers have started, lets access the application. You need to specify the IP address of the Machine where WildFly is running (swarm-node-01 in this example but update as needed for your cluster):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">curl http://$(docker-machine ip swarm-node-01):8080/couchbase-javaee/resources/airline
[{"travel-sample":{"id":10123,"iata":"TQ","icao":"TXW","name":"Texas Wings","callsign":"TXW","type":"airline","country":"United States"}}, {"travel-sample":{"id":10642,"iata":null,"icao":"JRB","name":"Jc royal.britannica","callsign":null,"type":"airline","country":"United Kingdom"}}, {"travel-sample":{"id":112,"iata":"5W","icao":"AEU","name":"Astraeus","callsign":"FLYSTAR","type":"airline","country":"United Kingdom"}}, {"travel-sample":{"id":1355,"iata":"BA","icao":"BAW","name":"British Airways","callsign":"SPEEDBIRD","type":"airline","country":"United Kingdom"}}, {"travel-sample":{"id":10765,"iata":"K5","icao":"SQH","name":"SeaPort Airlines","callsign":"SASQUATCH","type":"airline","country":"United States"}}, {"travel-sample":{"id":13633,"iata":"WQ","icao":"PQW","name":"PanAm World Airways","callsign":null,"type":"airline","country":"United States"}}, {"travel-sample":{"id":139,"iata":"SB","icao":"ACI","name":"Air Caledonie International","callsign":"AIRCALIN","type":"airline","country":"France"}}, {"travel-sample":{"id":13391,"iata":"-+","icao":"--+","name":"U.S. Air","callsign":null,"type":"airline","country":"United States"}}, {"travel-sample":{"id":1191,"iata":"UU","icao":"REU","name":"Air Austral","callsign":"REUNION","type":"airline","country":"France"}}, {"travel-sample":{"id":1316,"iata":"FL","icao":"TRS","name":"AirTran Airways","callsign":"CITRUS","type":"airline","country":"United States"}}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check state of the cluster by connecting to different nodes.</p>
</div>
<div class="paragraph">
<p>Add container visualization using <a href="https://github.com/javaee-samples/docker-java/issues/55" class="bare">https://github.com/javaee-samples/docker-java/issues/55</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_application_on_kubernetes_cluster">Deploy Application on Kubernetes Cluster</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Kubernetes is an open source system for managing containerized applications across multiple hosts, providing basic mechanisms for deployment, maintenance, and scaling of applications.
</blockquote>
<div class="attribution">
&#8212; github.com/GoogleCloudPlatform/kubernetes/
</div>
</div>
<div class="paragraph">
<p>Kubernetes, or &#8220;k8s&#8221; in short, allows the user to provide declarative primitives for the desired state, for example &#8220;need 5 WildFly servers and 1 MySQL server running&#8221;. Kubernetes self-healing mechanisms, such as auto-restarting, re-scheduling, and replicating containers then ensure that this state is met. The user just define the state and Kubernetes ensures that the state is met at all times on the cluster.</p>
</div>
<div class="paragraph">
<p><strong>How is it related to Docker?</strong></p>
</div>
<div class="paragraph">
<p>Docker provides the lifecycle management of containers. A Docker image defines a build time representation of the runtime containers. There are commands to start, stop, restart, link, and perform other lifecycle methods on these containers. Kubernetes uses Docker to package, instantiate, and run containerized applications.</p>
</div>
<div class="paragraph">
<p><strong>How does Kubernetes simplify containerized application deployment?</strong></p>
</div>
<div class="paragraph">
<p>A typical application would have a cluster of containers across multiple hosts. For example, your web tier (for example Apache) might run as a few instances, and likely on a set of containers. Similarly, your application tier (for example, WildFly) would run on a different set of containers. The web tier would need to delegate the request to application tier. The web, application, and database tier would generally run on a separate set of containers. These containers would need to talk to each other. Using any of the solutions mentioned above would require scripting to start the containers, and monitoring/bouncing if something goes down. Kubernetes does all of that for the user after the application state has been defined.</p>
</div>
<div class="sect2">
<h3 id="_key_components">Key Components</h3>
<div class="paragraph">
<p>At a very high level, there are three key components:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Pods</strong> are the smallest deployable units that can be created, scheduled, and managed. Its a logical collection of containers that belong to an application.</p>
</li>
<li>
<p><strong>Master</strong> is the central control point that provides a unified view of the cluster. There is a single master node that control multiple worker nodes.</p>
</li>
<li>
<p><strong>Node</strong> (née minion) is a worker node that run tasks as delegated by the master. Nodes can run one or more pods. It provides an application-specific &#8220;virtual host&#8221; in a containerized environment.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A picture is always worth a thousand words and so this is a high-level logical block diagram for Kubernetes:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/kubernetes-key-components.png" alt="kubernetes key components">
</div>
<div class="title">Figure 41. Kubernetes Key Components</div>
</div>
<div class="paragraph">
<p>After the 50,000 feet view, lets fly a little lower at 30,000 feet and take a look at how Kubernetes make all of this happen. There are a few key components at Master and Node that make this happen.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Replication Controller</strong> is a resource at Master that ensures that requested number of pods are running on nodes at all times.</p>
</li>
<li>
<p><strong>Service</strong> is an object on master that provides load balancing across a replicated group of pods.
Label is an arbitrary key/value pair in a distributed watchable storage that the Replication Controller uses for service discovery.</p>
</li>
<li>
<p><strong>Kubelet</strong> Each node runs services to run containers and be managed from the master. In addition to Docker, Kubelet is another key service installed there. It reads container manifests as YAML files that describes a pod. Kubelet ensures that the containers defined in the pods are started and continue running.</p>
</li>
<li>
<p>Master serves <strong>RESTful Kubernetes API</strong> that validate and configure Pod, Service, and Replication Controller.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_start_kubernetes_cluster">Start Kubernetes Cluster</h3>
<div class="paragraph">
<p>Kubernetes cluster can be easily started using Vagrant. There are two options to start the cluster - first using a downloaded Kubernetes distribution bundle and second by downloading the latest bundle as part of the install.</p>
</div>
<div class="sect3">
<h4 id="_using_previously_downloaded_kubernetes_distribution">Using Previously Downloaded Kubernetes Distribution</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Setup a Kubernetes cluster using a previously configured Kubernetes distribution as explained in <a href="#Kubernetes_Setup">Kubernetes</a>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">cd kubernetes
export KUBERNETES_PROVIDER=vagrant
./cluster/kube-up.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>KUBERNETES_PROVIDER</code> environment variable tells all of the various cluster management scripts which variant to use.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This will take a few minutes, so be patience! Vagrant will provision each machine in the cluster with all the necessary components to run Kubernetes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It shows the output as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">... Starting cluster using provider: vagrant
... calling verify-prereqs
... calling kube-up
Bringing machine 'master' up with 'virtualbox' provider...
Bringing machine 'minion-1' up with 'virtualbox' provider...
==&gt; master: Importing base box 'kube-fedora21'...
==&gt; master: Matching MAC address for NAT networking...
==&gt; master: Setting the name of the VM: kubernetes-112_master_1447998973006_60233

. . .

... calling validate-cluster
Found 1 node(s).
NAME         LABELS                              STATUS    AGE
10.245.1.3   kubernetes.io/hostname=10.245.1.3   Ready     11s
Validate output:
NAME                 STATUS    MESSAGE              ERROR
controller-manager   Healthy   ok                   nil
scheduler            Healthy   ok                   nil
etcd-0               Healthy   {"health": "true"}   nil
etcd-1               Healthy   {"health": "true"}   nil
Cluster validation succeeded
Done, listing cluster services:

Kubernetes master is running at https://10.245.1.2
Heapster is running at https://10.245.1.2/api/v1/proxy/namespaces/kube-system/services/heapster
KubeDNS is running at https://10.245.1.2/api/v1/proxy/namespaces/kube-system/services/kube-dns
KubeUI is running at https://10.245.1.2/api/v1/proxy/namespaces/kube-system/services/kube-ui
Grafana is running at https://10.245.1.2/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana
InfluxDB is running at https://10.245.1.2/api/v1/proxy/namespaces/kube-system/services/monitoring-influxdb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note down the address for Kubernetes master, <code><a href="https://10.245.1.2" class="bare">https://10.245.1.2</a></code> in this case.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_download_and_start_the_kubernetes_cluster">Download and Start the Kubernetes Cluster</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Alternatively, the cluster can also be started as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">export KUBERNETES_PROVIDER=vagrant
curl -sS https://get.k8s.io | bash
Downloading kubernetes release v1.1.1 to /Users/arungupta/tmp/kubernetes.tar.gz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  182M  100  182M    0     0  1158k      0  0:02:41  0:02:41 --:--:-- 1383k
Unpacking kubernetes release v1.1.1
Creating a kubernetes on vagrant...
... Starting cluster using provider: vagrant
... calling verify-prereqs
... calling kube-up
Bringing machine 'master' up with 'virtualbox' provider...
Bringing machine 'minion-1' up with 'virtualbox' provider...
==&gt; master: Importing base box 'kube-fedora21'...
==&gt; master: Matching MAC address for NAT networking...
==&gt; master: Setting the name of the VM: kubernetes_master_1447999746508_72335

. . .

... calling validate-cluster
Found 1 node(s).
NAME         LABELS                              STATUS    AGE
10.245.1.3   kubernetes.io/hostname=10.245.1.3   Ready     5s
Validate output:
NAME                 STATUS    MESSAGE              ERROR
controller-manager   Healthy   ok                   nil
scheduler            Healthy   ok                   nil
etcd-0               Healthy   {"health": "true"}   nil
etcd-1               Healthy   {"health": "true"}   nil
Cluster validation succeeded
Done, listing cluster services:

Kubernetes master is running at https://10.245.1.2
Heapster is running at https://10.245.1.2/api/v1/proxy/namespaces/kube-system/services/heapster
KubeDNS is running at https://10.245.1.2/api/v1/proxy/namespaces/kube-system/services/kube-dns
KubeUI is running at https://10.245.1.2/api/v1/proxy/namespaces/kube-system/services/kube-ui
Grafana is running at https://10.245.1.2/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana
InfluxDB is running at https://10.245.1.2/api/v1/proxy/namespaces/kube-system/services/monitoring-influxdb

Kubernetes binaries at /Users/arungupta/tmp/kubernetes/cluster/
You may want to add this directory to your PATH in $HOME/.profile
Installation successful!</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_verify_the_cluster">Verify the Cluster</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verify the Kubernetes cluster as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">vagrant status
Current machine states:

master                    running (virtualbox)
minion-1                  running (virtualbox)

This environment represents multiple VMs. The VMs are all listed
above with their current state. For more information about a specific
VM, run `vagrant status NAME`.</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the Vagrant setup will create a single Master and one node. Each VM will take 1 GB, so make sure you have at least 2GB to 4GB of free memory (plus appropriate free disk space).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
By default, only one node is created. This can be manipulated by setting an environment variable NUM_MINIONS variable to an integer before invoking <code>kube-up.sh</code> script.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/kubernetes-cluster-vagrant.png" alt="kubernetes cluster vagrant">
</div>
<div class="title">Figure 42. Kubernetes Cluster using Vagrant</div>
</div>
<div class="paragraph">
<p>By default, each VM in the cluster is running Fedora, Kubelet is installed into ``systemd'', and all other Kubernetes services are running as containers on Master.</p>
</div>
</li>
<li>
<p>Access <a href="https://10.245.1.2" class="bare">https://10.245.1.2</a> (or whatever IP address is assigned to your kubernetes cluster start up log). This may present the warning as shown below:</p>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/kubernetes-master-default-output-certificate.png" alt="kubernetes master default output certificate">
</div>
</div>
<div class="paragraph">
<p>Click on &#8216;Advanced&#8217;, on &#8216;Proceed to 10.245.1.2&#8217;, enter the username as &#8216;vagrant&#8217; and password as &#8216;vagrant&#8217; to see the output as:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/kubernetes-master-default-output.png" alt="kubernetes master default output">
</div>
<div class="title">Figure 43. Kubernetes Output from Master</div>
</div>
<div class="paragraph">
<p>Check the list of nodes as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get nodes
NAME         LABELS                              STATUS    AGE
10.245.1.3   kubernetes.io/hostname=10.245.1.3   Ready     1m</code></pre>
</div>
</div>
</li>
<li>
<p>Check the list of pods:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get po
NAME      READY     STATUS    RESTARTS   AGE</code></pre>
</div>
</div>
</li>
<li>
<p>Check the list of services running:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get svc
NAME         CLUSTER_IP   EXTERNAL_IP   PORT(S)   SELECTOR   AGE
kubernetes   10.247.0.1   &lt;none&gt;        443/TCP   &lt;none&gt;     3m</code></pre>
</div>
</div>
</li>
<li>
<p>Check the list of replication controllers:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get rc
CONTROLLER   CONTAINER(S)   IMAGE(S)   SELECTOR   REPLICAS</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Deploy_JavaEE_Kubernetes_Multiple_Config">Deploy Java EE Application (multiple configuration files)</h3>
<div class="paragraph">
<p>Pods, and the IP addresses assigned to them, are ephemeral. If a pod dies then Kubernetes will recreate that pod because of its self-healing features, but it might recreate it on a different host. Even if it is on the same host, a different IP address could be assigned to it. And so any application cannot rely upon the IP address of the pod.</p>
</div>
<div class="paragraph">
<p>Kubernetes services is an abstraction which defines a logical set of pods. A service is typically back-ended by one or more physical pods (associated using labels), and it has a permanent IP address that can be used by other pods/applications. For example, WildFly pod can not directly connect to a MySQL pod but can connect to MySQL service. In essence, Kubernetes service offers clients an IP and port pair which, when accessed, redirects to the appropriate backends.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./chapters/images/kubernetes-service.png" alt="kubernetes service">
</div>
<div class="title">Figure 44. Kubernetes Service</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In this case, all the pods are running on a single node. This is because, that is the default number for a Kubernetes cluster. The pod can be on another node if more number of nodes are configured to start in the cluster.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Any Service that a Pod wants to access must be created before the Pod itself, or else the environment variables will not be populated.</p>
</div>
<div class="paragraph">
<p>The order of Service and the targeted Pods does not matter. However Service needs to be started before any other Pods consuming the Service are started.</p>
</div>
<div class="sect3">
<h4 id="_start_couchbase_pod">Start Couchbase Pod</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start Couchbase Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh create -f ~/workspaces/docker-java/attendees/kubernetes/app-couchbase-pod.yaml
pod "couchbase-pod" created</code></pre>
</div>
</div>
<div class="paragraph">
<p>It uses the following configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: couchbase-pod
  labels:
    name: couchbase-pod
    context: docker-k8s-lab
spec:
  containers:
    -
      name: couchbase
      image: couchbase/server:latest
      ports:
        -
          containerPort: 8091
          containerPort: 8092
          containerPort: 8093
          containerPort: 11210</code></pre>
</div>
</div>
</li>
<li>
<p>Get status of the Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get -w po
NAME            READY     STATUS    RESTARTS   AGE
couchbase-pod   0/1       Pending   0          16s
NAME            READY     STATUS    RESTARTS   AGE
couchbase-pod   0/1       Running   0          40s
couchbase-pod   1/1       Running   0         40s</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>-w</code> watches for changes to the requested object. Wait for the Couchbase pod to be in Running status.</p>
</div>
<div class="paragraph">
<p>Hit <code>Ctrl</code> + <code>C</code> to terminate the watch.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_start_couchbase_service">Start Couchbase service</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start MySQL Service:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh create -f ~/workspaces/docker-java/attendees/kubernetes/app-couchbase-service.yaml
service "couchbase-service" created</code></pre>
</div>
</div>
<div class="paragraph">
<p>It uses the following configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  name: couchbase-service
  labels:
    name: couchbase-pod
    context: docker-k8s-lab
spec:
  ports:
    # the port that this service should serve on
    - name: admin
      port: 8091
    - name: run-queries
      port: 8092
    - name: rest-http
      port: 8093
    - name: nodes
      port: 11210
  # label keys and values that must match in order to receive traffic for this service
  selector:
    name: couchbase-pod
    context: docker-k8s-lab</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again, the label &#8220;context: docker-k8s-lab&#8221; is used. This simplifies querying the created pods later on.</p>
</div>
</li>
<li>
<p>Get status of the Service:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get svc
NAME                CLUSTER_IP      EXTERNAL_IP   PORT(S)                                SELECTOR                                    AGE
couchbase-service   10.247.202.53   &lt;none&gt;        8091/TCP,8092/TCP,8093/TCP,11210/TCP   context=docker-k8s-lab,name=couchbase-pod   1m
kubernetes          10.247.0.1      &lt;none&gt;        443/TCP                                &lt;none&gt;                                      32m</code></pre>
</div>
</div>
<div class="paragraph">
<p>If multiple services are running, then it can be narrowed by specifying the labels:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get svc -l context=docker-k8s-lab,name=couchbase-pod
NAME                CLUSTER_IP      EXTERNAL_IP   PORT(S)                                SELECTOR                                    AGE
couchbase-service   10.247.202.53   &lt;none&gt;        8091/TCP,8092/TCP,8093/TCP,11210/TCP   context=docker-k8s-lab,name=couchbase-pod   1m</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is also the selector label used by Service to target Pods.</p>
</div>
<div class="paragraph">
<p>When a Service is run on a node, the kubelet adds a set of environment variables for each active Service. It supports both Docker links compatible variables and simpler <code>{SVCNAME}_SERVICE_HOST</code> and <code>{SVCNAME}_SERVICE_PORT</code> variables, where the Service name is upper-cased and dashes are converted to underscores.</p>
</div>
<div class="paragraph">
<p>Our service name is &#8220;couchbase-service&#8221; and so <code>COUCHBASE_SERVICE_SERVICE_HOST</code> and <code>COUCHBASE_SERVICE_SERVICE_PORT</code> variables are available to other pods.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Kubernetes also allows services to be resolved using DNS configuration. Send a Pull Request for adding this functionality to the lab as explained in <a href="https://github.com/javaee-samples/docker-java/issues/62">#62</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_start_wildfly_replication_controller">Start WildFly Replication Controller</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start WildFly replication controller:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh create -f ~/workspaces/docker-java/attendees/kubernetes/app-wildfly-rc.yaml
replicationcontroller "wildfly-rc" created</code></pre>
</div>
</div>
<div class="paragraph">
<p>It uses the following configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ReplicationController
metadata:
  name: wildfly-rc
  labels:
    name: wildfly
    context: docker-k8s-lab
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: wildfly
    spec:
      containers:
      - name: wildfly-rc-pod
        image: arungupta/wildfly-mysql-javaee7:k8s
        ports:
        - containerPort: 8080</code></pre>
</div>
</div>
</li>
<li>
<p>Check status of the Replication Controller:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get rc
CONTROLLER   CONTAINER(S)     IMAGE(S)                              SELECTOR       REPLICAS   AGE
wildfly-rc   wildfly-rc-pod   arungupta/wildfly-mysql-javaee7:k8s   name=wildfly   1          1m</code></pre>
</div>
</div>
</li>
<li>
<p>Check status of the Pod inside Replication Controller:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get -w po
NAME               READY     STATUS    RESTARTS   AGE
mysql-pod          1/1       Running   0          4m
wildfly-rc-ca1ug   0/1       Pending   0          1m
NAME               READY     STATUS    RESTARTS   AGE
wildfly-rc-ca1ug   0/1       Running   0          3m
wildfly-rc-ca1ug   1/1       Running   0         3m</code></pre>
</div>
</div>
</li>
<li>
<p>Use the Pod&#8217;s name to get IP address:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get -o template po wildfly-rc-ca1ug --template={{.status.podIP}}
10.246.96.7</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="Access_Kubernetes_Application_Node">Access the application (using node)</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to node:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">vagrant ssh minion-1</code></pre>
</div>
</div>
</li>
<li>
<p>Access the application using <code>curl <a href="http://10.246.96.7:8080/employees/resources/employees" class="bare">http://10.246.96.7:8080/employees/resources/employees</a></code> and replace IP address with the one obtained earlier:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&gt; vagrant ssh minion-1
Last login: Sat Nov 21 01:02:52 2015 from 10.0.2.2
[vagrant@kubernetes-minion-1 ~]$ curl http://10.246.96.7:8080/employees/resources/employees
&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;&lt;collection&gt;&lt;employee&gt;&lt;id&gt;1&lt;/id&gt;&lt;name&gt;Penny&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;2&lt;/id&gt;&lt;name&gt;Sheldon&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;3&lt;/id&gt;&lt;name&gt;Amy&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;4&lt;/id&gt;&lt;name&gt;Leonard&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;5&lt;/id&gt;&lt;name&gt;Bernadette&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;6&lt;/id&gt;&lt;name&gt;Raj&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;7&lt;/id&gt;&lt;name&gt;Howard&lt;/name&gt;&lt;/employee&gt;&lt;employee&gt;&lt;id&gt;8&lt;/id&gt;&lt;name&gt;Priya&lt;/name&gt;&lt;/employee&gt;&lt;/collection&gt;[vagrant@kubernetes-minion-1 ~]</code></pre>
</div>
</div>
</li>
<li>
<p>Log out of the minion</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">[vagrant@kubernetes-minion-1 ~]$ exit
logout
Connection to 127.0.0.1 closed.</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="Access_Kubernetes_Application_Proxy">Access the application (using proxy)</h4>
<div class="paragraph">
<p>Send a PR for <a href="https://github.com/javaee-samples/docker-java/issues/80" class="bare">https://github.com/javaee-samples/docker-java/issues/80</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_java_ee_application_one_configuration_file">Deploy Java EE Application (one configuration file)</h3>
<div class="paragraph">
<p>Kubernetes allow multiple resources to be specified in a single configuration file. This allows to create a &#8220;Kubernetes Application&#8221; that can consists of multiple resources easily.</p>
</div>
<div class="paragraph">
<p><a href="#Deploy_JavaEE_Kubernetes_Multiple_Config">Deploy Java EE Application (multiple configuration files)</a> showed how to deploy the Java EE application using multiple configuration files. This application can be delpoyed using a single configuration file as well.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First delete the the existing pods and replication controller using the context label:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh delete svc,po,replicationController -l context="docker-k8s-lab"
service "mysql-service" deleted
pod "mysql-pod" deleted
replicationcontroller "wildfly-rc" deleted</code></pre>
</div>
</div>
</li>
<li>
<p>Start the application using the configuration file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: mysql-pod
  labels:
    name: mysql-pod
    context: docker-k8s-lab
spec:
  containers:
    -
      name: mysql
      image: mysql:latest
      env:
        -
          name: "MYSQL_USER"
          value: "mysql"
        -
          name: "MYSQL_PASSWORD"
          value: "mysql"
        -
          name: "MYSQL_DATABASE"
          value: "sample"
        -
          name: "MYSQL_ROOT_PASSWORD"
          value: "supersecret"
      ports:
        -
          containerPort: 3306
----
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  labels:
    name: mysql-pod
    context: docker-k8s-lab
spec:
  ports:
    # the port that this service should serve on
    - port: 3306
  # label keys and values that must match in order to receive traffic for this service
  selector:
    name: mysql-pod
    context: docker-k8s-lab
----
apiVersion: v1
kind: ReplicationController
metadata:
  name: wildfly-rc
  labels:
    name: wildfly
    context: docker-k8s-lab
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: wildfly
    spec:
      containers:
      - name: wildfly-rc-pod
        image: arungupta/wildfly-mysql-javaee7:k8s
        ports:
        - containerPort: 8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that each section, one each for MySQL Pod, MySQL Service, and WildFly Replication Controller, is separated by <code>----</code>.</p>
</div>
</li>
<li>
<p>Start the application:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh create -f ~/workspaces/docker-java/attendees/kubernetes/app.yaml
pod "mysql-pod" created
service "mysql-service" created
replicationcontroller "wildfly-rc" created</code></pre>
</div>
</div>
</li>
<li>
<p>Access the application using <a href="#Access_Kubernetes_Application_Node">Access the application (using node)</a> or <a href="#Access_Kubernetes_Application_Proxy">Access the application (using proxy)</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_rescheduling_pods">Rescheduling Pods</h3>
<div class="paragraph">
<p>Replication Controller ensures that specified number of pod &#8220;replicas&#8221; are running at any one time. If there are too many, the replication controller kills some pods. If there are too few, it starts more.</p>
</div>
<div class="paragraph">
<p>WildFly Replication Controller is already running with one Pod. Lets delete this Pod and see how a new Pod is automatically rescheduled.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Find the Pod&#8217;s name:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get po
NAME               READY     STATUS    RESTARTS   AGE
mysql-pod          1/1       Running   0          21s
wildfly-rc-l2cto   1/1       Running   0          21s</code></pre>
</div>
</div>
</li>
<li>
<p>Delete the Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh delete po wildfly-rc-l2cto
pod "wildfly-rc-l2cto" deleted</code></pre>
</div>
</div>
<div class="paragraph">
<p>Status of the Pods can be seen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get -w po
NAME               READY     STATUS        RESTARTS   AGE
mysql-pod          1/1       Running       0          1m
wildfly-rc-2o8vd   1/1       Running       0          13s
wildfly-rc-l2cto   1/1       Terminating   0          1m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how Pod with name &#8220;wildfly-rc-l2cto&#8221; was deleted and a new Pod with the name &#8220;wildfly-rc-2o8vd&#8221; was created. The status &#8220;Terminating&#8221; does not update correctly and is filed as <a href="https://github.com/kubernetes/kubernetes/issues/17612" class="bare">https://github.com/kubernetes/kubernetes/issues/17612</a>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_scaling_pods">Scaling Pods</h3>
<div class="paragraph">
<p>Replication Controller allows dynamic scaling up and down of Pods.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Scale up the number of Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh scale --replicas=2 rc wildfly-rc
replicationcontroller "wildfly-rc" scaled</code></pre>
</div>
</div>
</li>
<li>
<p>Status of the Pods can be seen in another shell:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get -w po
TBD</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pods are not scaled correctly as explained at <a href="https://github.com/kubernetes/kubernetes/issues/17613" class="bare">https://github.com/kubernetes/kubernetes/issues/17613</a>.</p>
</div>
<div class="paragraph">
<p>TBD: Notice a new Pod with the name &#8220;wildfly-rc-bymu7&#8221; is created.</p>
</div>
</li>
<li>
<p>Scale down the number of Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh scale --replicas=1 rc wildfly-rc
scaled</code></pre>
</div>
</div>
</li>
<li>
<p>Status of the Pods using <code>-w</code> is not shown correctly <a href="https://github.com/GoogleCloudPlatform/kubernetes/issues/11338">#11338</a>. But status of the Pods can be seen correctly as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get po
NAME               READY     STATUS    RESTARTS   AGE
wildfly-rc-bgtkg   1/1       Running   0          9m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice only one Pod is running now.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_couchbase_cluster_and_persistent_volumes">Couchbase Cluster and Persistent Volumes</h3>
<div class="paragraph">
<p>A <em>Kubernetes Volume</em> outlives any containers that run within the Pod, and data is preserved across Container restarts. However the volume will cease to exist when a Pod ceases to exist. This is solved by <em>Persistent Volumes</em> that provide persistent, cluster-scoped storage for applications that require long lived data.</p>
</div>
<div class="paragraph">
<p>Creating and using a persistent volume is a three step process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Administrator provision a <em>networked storage in the cluster</em>. This is called as <code>PersistentVolume</code>.</p>
</li>
<li>
<p>User requests storage for pods by using <em>claims</em>. Claims can specify levels of resources (CPU and memory), specific sizes and access modes (e.g. can be mounted once read/write or many times write only). This is called as <code>PersistentVolumeClaim</code>.</p>
</li>
<li>
<p>Claims are mounted as volumes and used in pods for storage.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_create_kubernetes_resources">Create Kubernetes resources</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create persistent volume:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">./cluster/kubectl.sh create -f ~/workspaces/docker-java/attendees/kubernetes/couchbase-pv.yaml
persistentvolume "pv001" created</code></pre>
</div>
</div>
</li>
<li>
<p>Create a claim for volume:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">./cluster/kubectl.sh create -f ~/workspaces/docker-java/attendees/kubernetes/couchbase-pvc.yaml
persistentvolumeclaim "pvc001" created</code></pre>
</div>
</div>
</li>
<li>
<p>Start the Couchbase Replication Controller (claim is used in Pod&#8217;s definition):</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">./cluster/kubectl.sh create -f ~/workspaces/docker-java/attendees/kubernetes/couchbase-rc.yaml
replicationcontroller "couchbase-rc" created</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check status of Replication Controller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">./cluster/kubectl.sh get -w po
NAME                 READY     STATUS    RESTARTS   AGE
couchbase-rc-s5o22   0/1       Pending   0          9s
NAME                 READY     STATUS    RESTARTS   AGE
couchbase-rc-s5o22   0/1       Running   0          47s
couchbase-rc-s5o22   1/1       Running   0         47s</code></pre>
</div>
</div>
</li>
<li>
<p>Start Couchbase Service:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">./cluster/kubectl.sh create -f ~/workspaces/docker-java/attendees/kubernetes/couchbase-service.yaml
service "couchbase-service" created</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_initialize_couchbase_cluster">Initialize Couchbase Cluster</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set data and index memory quota for Couchbase:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">./cluster/kubectl.sh exec couchbase-rc-s5o22 -- curl -v -X POST http://localhost:8091/pools/default -d memoryQuota=300 -d indexMemoryQuota=300</code></pre>
</div>
</div>
</li>
<li>
<p>Configure Data and Query service on Couchbase server:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">./cluster/kubectl.sh exec couchbase-rc-s5o22 -- /opt/couchbase/bin/couchbase-cli cluster-init -u Administrator -p password -c localhost:8091 --cluster-ramsize=256 --cluster-index-ramsize=256 --services=index,data,query
SUCCESS: init/edit localhost</code></pre>
</div>
</div>
</li>
<li>
<p>Install travel-sample bucket:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">./cluster/kubectl.sh exec couchbase-rc-s5o22 -- curl -v -u Administrator:password -X POST http://localhost:8091/sampleBuckets/install -d '["travel-sample"]'
*   Trying ::1...
* connect to ::1 port 8091 failed: Connection refused
*   Trying 127.0.0.1...
* Connected to localhost (127.0.0.1) port 8091 (#0)
* Server auth using Basic with user 'Administrator'
&gt; POST /sampleBuckets/install HTTP/1.1
&gt; Authorization: Basic QWRtaW5pc3RyYXRvcjpwYXNzd29yZA==
&gt; User-Agent: curl/7.40.0-DEV
&gt; Host: localhost:8091
&gt; Accept: */*
&gt; Content-Length: 17
&gt; Content-Type: application/x-www-form-urlencoded
&gt;
* upload completely sent off: 17 out of 17 bytes
&lt; HTTP/1.1 202 Accepted
&lt; Server: Couchbase Server
&lt; Pragma: no-cache
&lt; Date: Mon, 23 Nov 2015 04:31:22 GMT
&lt; Content-Type: application/json
&lt; Content-Length: 2
&lt; Cache-Control: no-cache
&lt;
* Connection #0 to host localhost left intact</code></pre>
</div>
</div>
</li>
<li>
<p>Query using <code>cbq</code> gives error:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">./cluster/kubectl.sh exec -it couchbase-rc-s5o22 -- /opt/couchbase/bin/cbq</code></pre>
</div>
</div>
<div class="paragraph">
<p>shows the message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">Couchbase query shell connected to http://localhost:8093/ . Type Ctrl-D to exit.</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_add_a_new_couchbase_server_to_the_cluster">Add a new Couchbase server to the cluster</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Scale using RC</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_application_logs">Application Logs</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get a list of the Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh get po
NAME               READY     STATUS    RESTARTS   AGE
mysql-pod          1/1       Running   0          18h
wildfly-rc-w2kk5   1/1       Running   0          16h</code></pre>
</div>
</div>
</li>
<li>
<p>Get logs for the WildFly Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">./cluster/kubectl.sh logs wildfly-rc-w2kk5
=&gt; Starting WildFly server
=&gt; Waiting for the server to boot
=========================================================================

  JBoss Bootstrap Environment

  JBOSS_HOME: /opt/jboss/wildfly

  . . .</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Logs can be obtained for any Kubernetes resources using this way. Alternatively, the logs can also be seen by logging into the node:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to the node VM:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&gt; vagrant ssh minion-1
Last login: Fri Jun  5 23:01:36 2015 from 10.0.2.2
[vagrant@kubernetes-minion-1 ~]$</code></pre>
</div>
</div>
</li>
<li>
<p>Log in as root:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">[vagrant@kubernetes-minion-1 ~]$ su -
Password:
[root@kubernetes-minion-1 ~]#</code></pre>
</div>
</div>
<div class="paragraph">
<p>Default root password for VM images created by Vagrant is &#8216;vagrant&#8217;.</p>
</div>
</li>
<li>
<p>See the list of Docker containers running on this VM:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker ps</code></pre>
</div>
</div>
</li>
<li>
<p>View WildFly log as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker logs $(docker ps | grep arungupta/wildfly | awk '{print $1}')</code></pre>
</div>
</div>
</li>
<li>
<p>View MySQL log as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker logs &lt;CID&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_delete_kubernetes_resources">Delete Kubernetes Resources</h3>
<div class="paragraph">
<p>Individual resources (service, replication controller, or pod) can be deleted by using <code>delete</code> command instead of <code>create</code> command. Alternatively, all services and replication controllers can be deleted using a label as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">kubectl delete -l se,po context=docker-k8s-lab</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stop_kubernetes_cluster">Stop Kubernetes Cluster</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&gt; ./cluster/kube-down.sh
Bringing down cluster using provider: vagrant
==&gt; minion-1: Forcing shutdown of VM...
==&gt; minion-1: Destroying VM and associated drives...
==&gt; master: Forcing shutdown of VM...
==&gt; master: Destroying VM and associated drives...
Done</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_debug_kubernetes_master">Debug Kubernetes Master</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to the master as:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">vagrant ssh master
Last login: Wed Jul 15 20:36:32 2015 from 10.0.2.2
[vagrant@kubernetes-master ~]$</code></pre>
</div>
</div>
</li>
<li>
<p>Log in as root:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">[vagrant@kubernetes-master ~]$ su -
Password:
[root@kubernetes-master ~]#</code></pre>
</div>
</div>
<div class="paragraph">
<p>Default root password for VM images created by Vagrant is &#8216;vagrant&#8217;.</p>
</div>
</li>
<li>
<p>Check the containers running on master:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">CONTAINER ID        IMAGE                                                                               COMMAND                CREATED             STATUS              PORTS               NAMES
dc59a764953c        gcr.io/google_containers/etcd:2.0.12                                                "/bin/sh -c '/usr/lo   20 hours ago        Up 20 hours                             k8s_etcd-container.fa2ab1d9_etcd-server-kubernetes-master_default_7b64ecafde589b94a342982699601a19_2b69c4d5
b722e22d3ddb        gcr.io/google_containers/kube-scheduler:d1107ff3b8fcdcbf5a9d78d9d6dbafb1            "/bin/sh -c '/usr/lo   20 hours ago        Up 20 hours                             k8s_kube-scheduler.7501c229_kube-scheduler-kubernetes-master_default_98b354f725c1589ea5a12119795546ae_b81b9740
38a73e342866        gcr.io/google_containers/kube-controller-manager:fafaf8100ccc963e643b55e35386d713   "/bin/sh -c '/usr/lo   20 hours ago        Up 20 hours                             k8s_kube-controller-manager.db050993_kube-controller-manager-kubernetes-master_default_f5c25224fbfb2de87e1e5c35e6b3a293_dcd4cb5d
01001de6409e        gcr.io/google_containers/kube-apiserver:cff9e185796caa8b281e7d961aea828b            "/bin/sh -c '/usr/lo   20 hours ago        Up 20 hours                             k8s_kube-apiserver.7e06f4e1_kube-apiserver-kubernetes-master_default_829f8c23fd5fc7951253cac7618447fc_b39c0a5d
0f8ccb144ece        gcr.io/google_containers/pause:0.8.0                                                "/pause"               20 hours ago        Up 20 hours                             k8s_POD.e4cc795_kube-scheduler-kubernetes-master_default_98b354f725c1589ea5a12119795546ae_eb1efcac
0b8f527456c0        gcr.io/google_containers/pause:0.8.0                                                "/pause"               20 hours ago        Up 20 hours                             k8s_POD.e4cc795_kube-apiserver-kubernetes-master_default_829f8c23fd5fc7951253cac7618447fc_5dd4dee7
39d9c41ab1a2        gcr.io/google_containers/pause:0.8.0                                                "/pause"               20 hours ago        Up 20 hours                             k8s_POD.e4cc795_kube-controller-manager-kubernetes-master_default_f5c25224fbfb2de87e1e5c35e6b3a293_522972ae
d970ddff7046        gcr.io/google_containers/pause:0.8.0                                                "/pause"               20 hours ago        Up 20 hours                             k8s_POD.e4cc795_etcd-server-kubernetes-master_default_7b64ecafde589b94a342982699601a19_fa75b27f</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Common_Docker_Commands">Common Docker Commands</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here is the list of commonly used Docker commands:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Command</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock"><strong>Image</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Build an image</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker build --rm=true .</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Install an image</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker pull ${IMAGE}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of installed images</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker images</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of installed images (detailed listing)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker images --no-trunc</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove an image</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker rmi ${IMAGE_ID}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove all untagged images</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker rmi $(docker images | grep “^” | awk “{print $3}”)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove all images</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker rm $(docker ps -aq)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove dangling images</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker rmi $(docker images --quiet --filter "dangling=true")</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock"><strong>Containers</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run a container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker run</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of running containers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker ps</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of all containers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker ps -a</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stop a container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker stop ${CID}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stop all running containers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker stop <code>docker ps -q</code></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">List all exited containers with status 1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker ps -a --filter "exited=1"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove a container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker rm ${CID}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove container by a regular expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker ps -a | grep wildfly | awk '{print $1}' | xargs docker rm -f</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove all exited containers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker rm -f $(docker ps -a | grep Exit | awk '{ print $1 }')</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove all containers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker rm $(docker ps -aq)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find IP address of the container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker inspect --format '{{ .NetworkSettings.IPAddress }}' ${CID}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Attach to a container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker attach ${CID}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open a shell in to a container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker exec -it ${CID} bash</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get container id for an image by a regular expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>docker ps | grep wildfly | awk '{print $1}'</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting">Troubleshooting</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_network_timed_out">Network Timed Out</h3>
<div class="paragraph">
<p>Depending upon the network speed and restrictions, you may not be able to download Docker images from Docker Hub. The error message may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ docker pull arungupta/wildfly-mysql-javaee7
Using default tag: latest
Pulling repository docker.io/arungupta/wildfly-mysql-javaee7
Network timed out while trying to connect to https://index.docker.io/v1/repositories/arungupta/wildfly-mysql-javaee7/images. You may want to check your internet connection or if you are behind a proxy.</code></pre>
</div>
</div>
<div class="paragraph">
<p>This section provide a couple of alternatives to solve this.</p>
</div>
<div class="sect3">
<h4 id="_restart_docker_machine">Restart Docker Machine</h4>
<div class="paragraph">
<p>It seems like Docker Machine gets into a strange state and restarting it fixes that.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker-machine restart &lt;MACHINE_NAME&gt;
eval $(docker-machine env &lt;MACHINE_NAME&gt;)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_loading_images_offline">Loading Images Offline</h4>
<div class="paragraph">
<p>Images can be downloaded from a previously saved <code>.tar</code> file. All images required for this workshop can be downloaded from:</p>
</div>
<div class="paragraph">
<p><a href="https://drive.google.com/folderview?id=0B8g4lYJ4uB37RkdqbFpPZU5ZS2s&amp;usp=sharing" class="bare">https://drive.google.com/folderview?id=0B8g4lYJ4uB37RkdqbFpPZU5ZS2s&amp;usp=sharing</a></p>
</div>
<div class="paragraph">
<p>Load the tar file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker load -i &lt;path to image tar file&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">docker load -i arungupta-javaee7-hol.tar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now <code>docker images</code> should show the image.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cannot_create_docker_machine_on_windows">Cannot create Docker Machine on Windows</h3>
<div class="paragraph">
<p>Are you not able to create Docker Machine on Windows?</p>
</div>
<div class="paragraph">
<p>Try starting a <code>cmd</code> with Administrator privileges and then give the command again.</p>
</div>
</div>
<div class="sect2">
<h3 id="_no_route_to_host">No route to host</h3>
<div class="paragraph">
<p>Accessing the WildFly and MySQL sample in Kubernetes gives 404 when you give the command <code>curl <a href="http://10.246.1.23:8080/employees/resources/employees/" class="bare">http://10.246.1.23:8080/employees/resources/employees/</a></code>.</p>
</div>
<div class="paragraph">
<p>This may be resolved by stopping the node and restarting the cluster again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">vagrant halt minion-1
./cluster/kube-up.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>These commands need to be given in the &#8216;kubernetes&#8217; directory.</p>
</div>
</div>
<div class="sect2">
<h3 id="_docker_machine_creation_fails_with_an_error_about_dial_tcp_i_o_timeout">Docker machine creation fails with an error about dial tcp: i/o timeout</h3>
<div class="paragraph">
<p>If you get the following error when creating a docker machine</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">Error creating machine: Error in driver during machine creation: Get https://api.github.com/repos/boot2docker/boot2docker/releases: dial tcp: i/o timeout</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you need to go to the boot2docker releases page on</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/boot2docker/boot2docker/releases" class="bare">https://github.com/boot2docker/boot2docker/releases</a></p>
</div>
<div class="paragraph">
<p>And download the latest .iso</p>
</div>
<div class="paragraph">
<p>After that you can move that iso to the docker cache directory. This is located in <code>~/.docker/machine/cache</code> on Mac &amp; Linux and <code>/Users/yourUserName/.docker/machine/cache</code> on Windows.</p>
</div>
<div class="paragraph">
<p>Issue: <a href="https://github.com/docker/machine/issues/2186" class="bare">https://github.com/docker/machine/issues/2186</a> is raised so that the docker-machine team can hopefully find a way around this.</p>
</div>
</div>
<div class="sect2">
<h3 id="__you_may_be_getting_rate_limited_by_github_error_message">&#8220;You may be getting rate limited by Github&#8221; error message</h3>
<div class="paragraph">
<p>Credits: <a href="https://github.com/docker/machine/blob/master/README.md#troubleshooting" class="bare">https://github.com/docker/machine/blob/master/README.md#troubleshooting</a></p>
</div>
<div class="paragraph">
<p>In order to <code>create</code> or <code>upgrade</code> virtual machines running Docker, Docker
Machine will check the Github API for the latest release of the [boot2docker
operating system](<a href="https://github.com/boot2docker/boot2docker" class="bare">https://github.com/boot2docker/boot2docker</a>).  The Github API
allows for a small number of unauthenticated requests from a given client, but
if you share an IP address with many other users (e.g. in an office), you may
get rate limited by their API, and Docker Machine will error out with messages
indicating this.</p>
</div>
<div class="paragraph">
<p>In order to work around this issue, you can <a href="https://help.github.com/articles/creating-an-access-token-for-command-line-use/">generate a
token</a> and pass it to Docker Machine using the global <code>--github-api-token</code> flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ docker-machine --github-api-token=token create -d virtualbox newbox</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should eliminate any issues you&#8217;ve been experiencing with rate limiting.</p>
</div>
</div>
<div class="sect2">
<h3 id="_docker_machine_troubleshooting">Docker Machine Troubleshooting</h3>
<div class="paragraph">
<p><a href="https://github.com/docker/machine/blob/master/README.md#troubleshooting">Docker Machine Troubleshooting</a> section has good tips on what can possibly go wrong with Docker Machine. Look there if your issue is not explained here.</p>
</div>
<div class="paragraph">
<p>===</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Docker Docs: <a href="http://docs.docker.com" class="bare">http://docs.docker.com</a></p>
</li>
<li>
<p>Kubernetes Docs: <a href="https://github.com/kubernetes/kubernetes/tree/master/docs" class="bare">https://github.com/kubernetes/kubernetes/tree/master/docs</a></p>
</li>
<li>
<p>JBoss and Docker: <a href="http://www.jboss.org/docker/" class="bare">http://www.jboss.org/docker/</a></p>
</li>
<li>
<p>Latest lab content: <a href="https://github.com/javaee-samples/docker-java" class="bare">https://github.com/javaee-samples/docker-java</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-11-05 12:45:27 PST
</div>
</div>
</body>
</html>